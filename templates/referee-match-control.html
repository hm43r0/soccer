<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Referee Dashboard - Start Match</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#6366f1",
              secondary: "#8b5cf6",
            },
          },
        },
      };
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }
      .glassmorphism {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .card-hover {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .card-hover:hover {
        transform: translateY(-4px);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      }
      .hidden {
        display: none;
      }

      /* --- STYLES COPIED FROM ADMIN DASHBOARD & CUSTOM DATALIST STYLING --- */
      .custom-checkbox {
        display: inline-block;
        position: relative;
        width: 18px;
        height: 18px;
      }

      .custom-checkbox input[type="checkbox"] {
        opacity: 0;
        width: 18px;
        height: 18px;
        margin: 0;
        position: absolute;
        left: 0;
        top: 0;
        z-index: 2;
        cursor: pointer;
      }

      .custom-checkbox span {
        display: block;
        width: 18px;
        height: 18px;
        border-radius: 4px;
        border: 2px solid #22c55e;
        /* Default green */
        background: transparent;
        box-sizing: border-box;
        position: absolute;
        left: 0;
        top: 0;
        z-index: 1;
        pointer-events: none;
      }

      /* Green (Goal) */
      .custom-checkbox input[type="checkbox"]:checked + span {
        background: #22c55e;
        border-color: #22c55e;
      }

      .custom-checkbox input[type="checkbox"]:checked + span::after {
        content: "";
        position: absolute;
        left: 4px;
        top: 0px;
        width: 5px;
        height: 10px;
        border: solid #fff;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
        pointer-events: none;
      }

      /* Blue Card */
      .blue-checkbox span {
        border-color: #3b82f6;
      }

      .blue-checkbox input[type="checkbox"]:checked + span {
        background: #3b82f6;
        border-color: #3b82f6;
      }

      /* Yellow Card */
      .yellow-checkbox span {
        border-color: #f59e0b;
      }
      .yellow-checkbox input[type="checkbox"]:checked + span {
        background: #f59e0b;
        border-color: #f59e0b;
      }

      /* Red Card */
      .red-checkbox span {
        border-color: #ef4444;
      }
      .red-checkbox input[type="checkbox"]:checked + span {
        background: #ef4444;
        border-color: #ef4444;
      }

      /* Yellow Card */
      .yellow-checkbox span {
        border-color: #facc15;
      }

      .yellow-checkbox input[type="checkbox"]:checked + span {
        background: #facc15;
        border-color: #facc15;
      }

      /* Red Card */
      .red-checkbox span {
        border-color: #ef4444;
      }

      .red-checkbox input[type="checkbox"]:checked + span {
        background: #ef4444;
        border-color: #ef4444;
      }
      .player-events-table {
        overflow-x: auto;
      }

      /* Hide number input spinners */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        appearance: textfield;
        -moz-appearance: textfield;
      }

      /* Custom Datalist Styling for dropdown appearance */
      /* Note: Datalist styling can be inconsistent across browsers */
      datalist {
        background: #2d3748; /* Dark background for the dropdown itself */
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        overflow: hidden; /* Helps with rounded corners for the overall box */
      }

      datalist option {
        background: #2d3748; /* Dark background for individual options */
        color: white;
        padding: 10px 15px; /* Adjust padding as needed */
        border-bottom: 1px solid rgba(255, 255, 255, 0.08); /* Subtle separator */
        cursor: pointer;
        white-space: nowrap; /* Prevent text wrapping */
        overflow: hidden;
        text-overflow: ellipsis; /* Add ellipsis if text is too long */
      }

      datalist option:last-child {
        border-bottom: none; /* No border on the last option */
      }

      /* Highlight on hover/focus (browser dependent) */
      datalist option:hover,
      datalist option:focus {
        background: #4a5568; /* Slightly lighter dark for hover */
      }

      /* Input styling for datalist */
      input[list] {
        /* Remove default browser styling for select-like input */
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
      }

      /* Image Popup Styles */
      .image-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        backdrop-filter: blur(10px);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .image-popup-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      /* Attendance Popup Styles */
      .attendance-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        backdrop-filter: blur(10px);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .attendance-popup-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .attendance-popup-content {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        padding: 24px;
        max-width: 90vw;
        max-height: 90vh;
        width: 800px;
        overflow-y: auto;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      }

      .attendance-team-section {
        margin-bottom: 24px;
      }

      .attendance-player-item {
        display: flex;
        align-items: center;
        padding: 12px;
        margin: 8px 0;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .attendance-player-item:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(4px);
      }

      .attendance-checkbox {
        margin-right: 12px;
        transform: scale(1.2);
      }

      .attendance-player-info {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .attendance-player-id {
        background: rgba(99, 102, 241, 0.2);
        color: #a5b4fc;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 600;
        min-width: 40px;
        text-align: center;
      }

      .attendance-player-name {
        color: #e2e8f0;
        font-weight: 500;
      }

      .attendance-popup-buttons {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .attendance-btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
      }

      .attendance-btn-cancel {
        background: rgba(239, 68, 68, 0.2);
        color: #fca5a5;
        border: 1px solid rgba(239, 68, 68, 0.3);
      }

      .attendance-btn-cancel:hover {
        background: rgba(239, 68, 68, 0.3);
        transform: translateY(-2px);
      }

      .attendance-btn-start {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
      }

      .attendance-btn-start:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
      }

      .attendance-btn-start:disabled {
        background: rgba(107, 114, 128, 0.5);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .select-all-checkbox {
        transform: scale(1.1);
        margin-right: 6px;
      }

      .attendance-team-section {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 20px;
      }

      .attendance-team-section:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }

      /* Card reason dropdown/input tweaks */
      .player-events-table select.reason-select {
        background: #fff;
        color: #111827;
        appearance: auto;
        -webkit-appearance: auto;
        -moz-appearance: auto;
      }
      .player-events-table input.reason-other-input::placeholder {
        color: rgba(255,255,255,0.6);
      }

      /* Ensure reason UI is hidden by default and only shown when .hidden is removed */
      .player-events-table select.reason-select,
      .player-events-table input.reason-other-input {
        display: none !important;
      }
      .player-events-table select.reason-select:not(.hidden),
      .player-events-table input.reason-other-input:not(.hidden) {
        display: inline-block !important;
      }

      /* Force dropdown options readable colors */
      .player-events-table select.reason-select option {
        color: #111827;
        background: #ffffff;
      }

      /* Score Edit Popup Styles */
      .score-edit-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        backdrop-filter: blur(10px);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }
      .score-edit-popup-overlay.active { opacity: 1; visibility: visible; }
      .score-edit-popup-content {
        background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 16px;
        width: 95vw;
        max-width: 1100px;
        max-height: 90vh;
        overflow-y: auto;
        padding: 16px;
      }
      .score-edit-popup-header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 8px; }
      .score-edit-close {
        background: rgba(239,68,68,0.2);
        border: 1px solid rgba(239,68,68,0.3);
        color: #fecaca;
        border-radius: 8px;
        padding: 6px 10px;
        cursor: pointer;
      }

      .image-popup-content {
        position: relative;
        max-width: 90vw;
        max-height: 90vh;
        transform: scale(0.8);
        transition: transform 0.3s ease;
      }

      .image-popup-overlay.active .image-popup-content {
        transform: scale(1);
      }

      .image-popup-content img {
        height: 40vh;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }

      .image-popup-close {
        position: absolute;
        top: -40px;
        right: -40px;
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        color: white;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .image-popup-close:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
      }

      .team-jersey-image {
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .team-jersey-image:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen"
  >
    <!-- Animated Background Elements -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
      <div
        class="absolute -top-40 -right-40 w-80 h-80 bg-purple-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-float"
      ></div>
      <div
        class="absolute -bottom-40 -left-40 w-80 h-80 bg-blue-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-float"
        style="animation-delay: 2s"
      ></div>
      <div
        class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-80 h-80 bg-pink-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-float"
        style="animation-delay: 4s"
      ></div>
    </div>
    <div class="flex">
      <div class="main-content flex-1 overflow-y-auto">
        <header
          class="header glassmorphism border-b border-white/10 p-6 flex items-center justify-between"
        >
          <div>
            <h2 class="text-2xl font-bold text-white">Referee Match Control</h2>
            <p class="text-gray-400">Start and manage your assigned matches</p>
          </div>
        </header>
        <div class="p-6">
          <!-- Referee Stat Cards Section -->
          <div
            id="referee-stat-cards"
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10"
          >
            <div
              class="glassmorphism rounded-2xl p-6 border border-white/10 flex items-center justify-between"
            >
              <div>
                <div class="text-gray-300 text-sm font-medium mb-1">
                  Total Matches
                </div>
                <div id="stat-total" class="text-3xl font-bold text-white">
                  0
                </div>
              </div>
              <div class="bg-indigo-600/20 rounded-xl p-3">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-8 w-8 text-indigo-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 7v4a1 1 0 001 1h3m10-5h3a1 1 0 011 1v4a1 1 0 01-1 1h-3m-10 4h10m-10 4h10"
                  />
                </svg>
              </div>
            </div>
            <div
              class="glassmorphism rounded-2xl p-6 border border-white/10 flex items-center justify-between"
            >
              <div>
                <div class="text-gray-300 text-sm font-medium mb-1">
                  Today's Matches
                </div>
                <div id="stat-today" class="text-3xl font-bold text-white">
                  0
                </div>
              </div>
              <div class="bg-green-600/20 rounded-xl p-3">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-8 w-8 text-green-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </div>
            </div>
            <div
              class="glassmorphism rounded-2xl p-6 border border-white/10 flex items-center justify-between"
            >
              <div>
                <div class="text-gray-300 text-sm font-medium mb-1">
                  Upcoming
                </div>
                <div id="stat-upcoming" class="text-3xl font-bold text-white">
                  0
                </div>
              </div>
              <div class="bg-orange-500/20 rounded-xl p-3">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-8 w-8 text-orange-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </div>
            </div>
            <div
              class="glassmorphism rounded-2xl p-6 border border-white/10 flex items-center justify-between"
            >
              <div>
                <div class="text-gray-300 text-sm font-medium mb-1">
                  Completed
                </div>
                <div id="stat-completed" class="text-3xl font-bold text-white">
                  0
                </div>
              </div>
              <div class="bg-blue-600/20 rounded-xl p-3">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-8 w-8 text-blue-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                  />
                </svg>
              </div>
            </div>
          </div>
          <!-- Referee Matches Cards Section -->
          <div
            id="referee-matches-list"
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"
          ></div>
          <!-- Admin Start Match Logic Copied Below -->
          <div id="admin-start-match-root" class="hidden"></div>
          <!-- Messages -->
          <div id="referee-messages" class="mt-6"></div>
        </div>
      </div>
    </div>

    <!-- Image Popup Modal -->
    <div id="imagePopup" class="image-popup-overlay">
      <div class="image-popup-content">
        <button class="image-popup-close" onclick="closeImagePopup()">
          &times;
        </button>
        <img id="popupImage" src="" alt="Team Jersey" />
      </div>
    </div>

    <!-- Attendance Popup Modal -->
    <div id="attendancePopup" class="attendance-popup-overlay">
      <div class="attendance-popup-content">
        <h2 class="text-2xl font-bold text-white mb-6 text-center">
          Mark Player Attendance
        </h2>
        <div id="attendanceContent">
          <!-- Attendance content will be populated by JavaScript -->
        </div>
        <div class="attendance-popup-buttons">
          <button
            type="button"
            class="attendance-btn attendance-btn-cancel"
            onclick="closeAttendancePopup()"
          >
            Cancel
          </button>
          <button
            type="button"
            id="startMatchBtn"
            class="attendance-btn attendance-btn-start"
            onclick="proceedWithMatch()"
          >
            Start Match
          </button>
        </div>
      </div>
    </div>

    <!-- Score Edit Popup Modal -->
    <div id="scoreEditPopup" class="score-edit-popup-overlay">
      <div class="score-edit-popup-content">
        <div class="score-edit-popup-header">
          <h2 class="text-xl font-semibold text-white">Match Score & Cards</h2>
          <button class="score-edit-close" onclick="window.closeScoreEditPopup()">Close</button>
        </div>
        <div id="scoreEditRoot" class="p-2"></div>
      </div>
    </div>

    <script>
      // Image Popup Functions
      function openImagePopup(imageUrl, altText) {
        const popup = document.getElementById("imagePopup");
        const popupImage = document.getElementById("popupImage");

        popupImage.src = imageUrl;
        popupImage.alt = altText;
        popup.classList.add("active");

        // Prevent body scroll when popup is open
        document.body.style.overflow = "hidden";
      }

      function closeImagePopup() {
        const popup = document.getElementById("imagePopup");
        popup.classList.remove("active");

        // Restore body scroll
        document.body.style.overflow = "auto";
      }

      // Close popup when clicking on overlay
      document.addEventListener("DOMContentLoaded", function () {
        const popup = document.getElementById("imagePopup");
        popup.addEventListener("click", function (e) {
          if (e.target === popup) {
            closeImagePopup();
          }
        });

        // Close popup with Escape key
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            closeImagePopup();
            closeAttendancePopup();
          }
        });

        // Add attendance popup event listeners
        const attendancePopup = document.getElementById("attendancePopup");
        attendancePopup.addEventListener("click", function (e) {
          if (e.target === attendancePopup) {
            closeAttendancePopup();
          }
        });
      });

      jQuery(document).ready(function ($) {
        let allMatches = []; // Store all match data including teams and players

        function loadRefereeMatches() {
          // Reset attendance data when loading matches
          attendanceData = { team1: [], team2: [] };
          currentMatchId = null;
          
          $.ajax({
            url: your_plugin_ajax_object.ajax_url,
            type: "POST",
            data: {
              action: "your_plugin_fetch_referee_matches",
              nonce: your_plugin_ajax_object.nonce,
            },
            success: function (response) {
              if (response.success && response.data.length > 0) {
                allMatches = response.data;
                renderRefereeMatchesList();
              } else {
                $("#referee-matches-list").html(
                  '<div class="text-white col-span-full text-center py-10">No matches assigned to you.</div>'
                );
                updateStatCards([]);
              }
            },
            error: function () {
              showMessage("Error loading matches.", "error");
            },
          });
        }

        function updateStatCards(matches) {
          const today = new Date().toISOString().slice(0, 10);
          let todayCount = 0;
          let upcomingCount = 0;
          let completedCount = 0;

          matches.forEach((match) => {
            if (match.is_completed === "1" || match.is_completed === 1) {
              completedCount++;
            } else if (match.date === today) {
              todayCount++;
            } else if (new Date(match.date) > new Date(today)) {
              upcomingCount++;
            }
          });

          $("#stat-total").text(matches.length);
          $("#stat-today").text(todayCount);
          $("#stat-upcoming").text(upcomingCount);
          $("#stat-completed").text(completedCount);
        }

        function renderRefereeMatchesList() {
          updateStatCards(allMatches);
          const today = new Date().toISOString().slice(0, 10);

          // Separate matches by status
          let todayMatches = [],
            upcomingMatches = [],
            pastIncompleteMatches = [],
            completedMatches = [];

          allMatches.forEach(function (match) {
            if (match.is_completed === "1" || match.is_completed === 1) {
              completedMatches.push(match);
            } else {
              const matchDate = new Date(match.date);
              const todayDate = new Date(today);
              if (match.date === today) {
                todayMatches.push(match);
              } else if (matchDate > todayDate) {
                upcomingMatches.push(match);
              } else {
                pastIncompleteMatches.push(match);
              }
            }
          });

          // Define comparison function for sorting by date ascending
          function byDateAsc(a, b) {
            return a.date.localeCompare(b.date);
          }

          // Sort each group
          todayMatches.sort(byDateAsc);
          upcomingMatches.sort(byDateAsc);
          pastIncompleteMatches.sort(byDateAsc);

          // Sort completed matches by date descending (newest first)
          completedMatches.sort(function (a, b) {
            return b.date.localeCompare(a.date);
          });

          let html = "";
          function matchCard(match, status, btn, extraClass = "") {
            return `<div class="card-hover glassmorphism rounded-2xl p-6 border border-white/10 flex flex-col justify-between ${extraClass}">
          <div>
            <div class="flex items-center justify-between mb-4">
               <div class="flex items-center">
                  <img src="${
                    match.team1Jersey || "https://via.placeholder.com/40"
                  }" alt="${match.team1Name} Jersey" class="w-20 h-20 rounded-full object-cover mr-3 border-2 border-white/20">
                  <img src="${
                    match.team2Jersey || "https://via.placeholder.com/40"
                  }" alt="${match.team2Name} Jersey" class="w-20 h-20 rounded-full object-cover -ml-5 border-2 border-white/20">
                  <span class="text-lg font-bold text-white ml-3">${
                    match.team1Name
                  } vs ${match.team2Name}</span>
              </div>
              ${status}
            </div>
            <div class="text-gray-300 text-sm mb-1"><span class="font-medium">Date:</span> ${
              match.date
            }</div>
            <div class="text-gray-300 text-sm mb-1"><span class="font-medium">Location:</span> ${
              match.location || "N/A"
            }</div>
            <div class="text-gray-300 text-sm mb-1"><span class="font-medium">Week:</span> ${
              match.week || "N/A"
            }</div>
          </div>
          ${btn}
        </div>`;
          }

          // Today's matches
          todayMatches.forEach(function (match) {
            html += matchCard(
              match,
              '<span class="inline-block px-3 py-1 rounded-full bg-green-600 text-white text-xs font-semibold">Today</span>',
              `<button class="start-match-card-btn mt-4 w-full bg-gradient-to-r from-green-500 to-green-700 text-white py-2 px-4 rounded-lg font-semibold hover:from-green-600 hover:to-green-800 transition-all" data-match-id="${match.id}">Start Match</button>`
            );
          });

          // Upcoming matches
          upcomingMatches.forEach(function (match) {
            html += matchCard(
              match,
              '<span class="inline-block px-3 py-1 rounded-full bg-orange-500 text-white text-xs font-semibold">Upcoming</span>',
              `<button class="mt-4 w-full bg-gradient-to-r from-gray-500 to-gray-700 text-white py-2 px-4 rounded-lg font-semibold cursor-not-allowed opacity-60" disabled>Upcoming</button>`
            );
          });

          // Past, incomplete matches
          pastIncompleteMatches.forEach(function (match) {
            html += matchCard(
              match,
              '<span class="inline-block px-3 py-1 rounded-full bg-red-600 text-white text-xs font-semibold">Past Due</span>',
              `<button class="start-match-card-btn mt-4 w-full bg-gradient-to-r from-yellow-500 to-yellow-700 text-white py-2 px-4 rounded-lg font-semibold hover:from-yellow-600 hover:to-yellow-800 transition-all" data-match-id="${match.id}">Enter Score</button>`
            );
          });

          // Completed matches
          completedMatches.forEach(function (match) {
            html += matchCard(
              match,
              '<span class="inline-block px-3 py-1 rounded-full bg-blue-600 text-white text-xs font-semibold">Completed</span>',
              `<div class="mt-4 grid grid-cols-1 gap-2">
                 <button class="w-full bg-gradient-to-r from-blue-500 to-blue-700 text-white py-2 px-4 rounded-lg font-semibold hover:from-blue-600 hover:to-blue-800 transition-all view-score-btn" data-match-id="${match.id}">View / Edit Score</button>
               </div>`,
              "opacity-70"
            );
          });
          $("#referee-matches-list").html(html);
        }

        // Card Start Match button click - Modified to show attendance popup first
        $(document).on("click", ".start-match-card-btn", function () {
          const matchId = $(this).data("match-id");
          if (!matchId) return;
          
          const match = allMatches.find((m) => m.id == matchId);
          if (!match) {
            showMessage("Match not found!", "error");
            return;
          }
          
          // Show attendance popup instead of directly starting match
          showAttendancePopup(matchId);
        });

        // Open score edit popup for completed match
        $(document).on('click', '.view-score-btn', function () {
          const matchId = $(this).data('match-id');
          if (!matchId) return;
          openScoreEditPopup(matchId);
        });

        function openScoreEditPopup(matchId) {
          const match = allMatches.find((m) => m.id == matchId);
          if (!match) { showMessage('Match not found.', 'error'); return; }

          // Show loading
          $('#scoreEditRoot').html('<div class="text-white/80 p-6">Loading match data...</div>');
          $('#scoreEditPopup').addClass('active');

          // Fetch saved summary/meta for this match
          $.ajax({
            url: your_plugin_ajax_object.ajax_url,
            type: 'POST',
            data: { action: 'your_plugin_get_match_summary', nonce: your_plugin_ajax_object.nonce, match_id: matchId },
            success: function (resp) {
              // Build team members as in start flow
              fetchTeamMembers(match.team1Id, match.team2Id, function (team1Data, team2Data) {
                
                console.log('Original team1Data:', team1Data);
                console.log('Original team2Data:', team2Data);
                
                // Filter team members based on attendance data if available
                let filteredTeam1Members = team1Data.members || [];
                let filteredTeam2Members = team2Data.members || [];
                
                if (resp && resp.success && resp.data && resp.data.score_data) {
                  try {
                    const scoreData = typeof resp.data.score_data === 'string' 
                      ? JSON.parse(resp.data.score_data) 
                      : resp.data.score_data;
                    
                    console.log('Score data for editing:', scoreData);
                    
                    // Filter team1 members based on attendance
                    if (scoreData.team1 && scoreData.team1.attendance && scoreData.team1.attendance.length > 0) {
                      const attendance = scoreData.team1.attendance;
                      console.log('Team1 raw attendance data:', attendance);
                      
                      // Handle both formats: array of IDs or array of player objects
                      let team1AttendanceIds = [];
                      if (attendance.length > 0) {
                        if (typeof attendance[0] === 'object' && attendance[0].id !== undefined) {
                          // Format: [{id: "123", name: "Player Name"}, ...]
                          team1AttendanceIds = attendance.map(player => String(player.id));
                          console.log('Team1 - Attendance stored as objects, extracted IDs:', team1AttendanceIds);
                        } else {
                          // Format: ["123", "456", ...]
                          team1AttendanceIds = attendance.map(id => String(id));
                          console.log('Team1 - Attendance stored as IDs:', team1AttendanceIds);
                        }
                      }
                      
                      filteredTeam1Members = team1Data.members.filter(member => {
                        const memberMatches = team1AttendanceIds.includes(String(member.id));
                        if (memberMatches) {
                          console.log(`Team1 - Found present player: ID=${member.id}, Name=${member.name}`);
                        }
                        return memberMatches;
                      });
                      console.log(`Filtered team1 from ${team1Data.members.length} to ${filteredTeam1Members.length} present players`);
                      console.log('Team1 filtered members:', filteredTeam1Members);
                    }
                    
                    // Filter team2 members based on attendance
                    if (scoreData.team2 && scoreData.team2.attendance && scoreData.team2.attendance.length > 0) {
                      const attendance = scoreData.team2.attendance;
                      console.log('Team2 raw attendance data:', attendance);
                      
                      // Handle both formats: array of IDs or array of player objects
                      let team2AttendanceIds = [];
                      if (attendance.length > 0) {
                        if (typeof attendance[0] === 'object' && attendance[0].id !== undefined) {
                          // Format: [{id: "123", name: "Player Name"}, ...]
                          team2AttendanceIds = attendance.map(player => String(player.id));
                          console.log('Team2 - Attendance stored as objects, extracted IDs:', team2AttendanceIds);
                        } else {
                          // Format: ["123", "456", ...]
                          team2AttendanceIds = attendance.map(id => String(id));
                          console.log('Team2 - Attendance stored as IDs:', team2AttendanceIds);
                        }
                      }
                      
                      filteredTeam2Members = team2Data.members.filter(member => {
                        const memberMatches = team2AttendanceIds.includes(String(member.id));
                        if (memberMatches) {
                          console.log(`Team2 - Found present player: ID=${member.id}, Name=${member.name}`);
                        }
                        return memberMatches;
                      });
                      console.log(`Filtered team2 from ${team2Data.members.length} to ${filteredTeam2Members.length} present players`);
                      console.log('Team2 filtered members:', filteredTeam2Members);
                    }
                  } catch (e) {
                    console.warn('Could not parse score data for attendance filtering:', e);
                  }
                }
                
                const team1 = { 
                  name: team1Data.name || match.team1Name || 'Unknown Team', 
                  members: filteredTeam1Members, // Use filtered members
                  jersey_image_url: team1Data.jersey_image_url || null 
                };
                const team2 = { 
                  name: team2Data.name || match.team2Name || 'Unknown Team', 
                  members: filteredTeam2Members, // Use filtered members
                  jersey_image_url: team2Data.jersey_image_url || null 
                };

                // Render match UI inside popup root (re-using same renderer)
                renderMatchInterfaceInto('#scoreEditRoot', match, team1, team2, resp && resp.success ? resp.data : null);
              });
            },
            error: function () {
              showMessage('Failed to load match data.', 'error');
            }
          });
        }

        function closeScoreEditPopup() {
          $('#scoreEditPopup').removeClass('active');
          $('#scoreEditRoot').empty();
          // Reset existing attendance data after editing
          existingAttendanceData = { team1: [], team2: [] };
        }
        window.closeScoreEditPopup = closeScoreEditPopup;

        // Global variables for attendance
        let currentMatchId = null;
        let attendanceData = {
          team1: [],
          team2: []
        };
        
        // Store existing attendance data when editing matches
        let existingAttendanceData = {
          team1: [],
          team2: []
        };

        function showAttendancePopup(matchId) {
          currentMatchId = matchId;
          
          // Reset existing attendance data when starting a new match
          existingAttendanceData = { team1: [], team2: [] };
          
          const match = allMatches.find((m) => m.id == matchId);
          
          // Fetch team members for attendance
          fetchTeamMembers(
            match.team1Id,
            match.team2Id,
            function (team1Data, team2Data) {
              renderAttendancePopup(match, team1Data, team2Data);
              $("#attendancePopup").addClass("active");
            }
          );
        }

        function renderAttendancePopup(match, team1Data, team2Data) {
          const team1 = {
            name: team1Data.name || match.team1Name || "Unknown Team",
            members: team1Data.members || [],
            jersey_image_url: team1Data.jersey_image_url || null
          };
          const team2 = {
            name: team2Data.name || match.team2Name || "Unknown Team", 
            members: team2Data.members || [],
            jersey_image_url: team2Data.jersey_image_url || null
          };

          let attendanceHtml = '';
          
          // Team 1 Attendance Section
          attendanceHtml += `
            <div class="attendance-team-section">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                  ${team1.jersey_image_url ? `<img src="${team1.jersey_image_url}" alt="${team1.name} Jersey" class="w-12 h-12 rounded-full object-cover mr-3 border-2 border-white/20">` : ''}
                  <h3 class="text-xl font-bold text-white">${team1.name}</h3>
                </div>
                <div class="flex items-center gap-2">
                  <input type="checkbox" id="selectAllTeam1" class="select-all-checkbox" data-team="1">
                  <label for="selectAllTeam1" class="text-sm text-gray-300 cursor-pointer">Select All</label>
                </div>
              </div>
              <div class="space-y-2">
          `;

          team1.members.forEach(member => {
            attendanceHtml += `
              <div class="attendance-player-item">
                <input type="checkbox" class="attendance-checkbox team-1-checkbox" data-team="1" data-player-id="${member.id}" data-player-name="${member.name}">
                <div class="attendance-player-info">
                  <div class="attendance-player-id">${member.id}</div>
                  <div class="attendance-player-name">${member.name}</div>
                </div>
              </div>
            `;
          });

          attendanceHtml += `
              </div>
            </div>
          `;

          // Team 2 Attendance Section
          attendanceHtml += `
            <div class="attendance-team-section">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                  ${team2.jersey_image_url ? `<img src="${team2.jersey_image_url}" alt="${team2.name} Jersey" class="w-12 h-12 rounded-full object-cover mr-3 border-2 border-white/20">` : ''}
                  <h3 class="text-xl font-bold text-white">${team2.name}</h3>
                </div>
                <div class="flex items-center gap-2">
                  <input type="checkbox" id="selectAllTeam2" class="select-all-checkbox" data-team="2">
                  <label for="selectAllTeam2" class="text-sm text-gray-300 cursor-pointer">Select All</label>
                </div>
              </div>
              <div class="space-y-2">
          `;

          team2.members.forEach(member => {
            attendanceHtml += `
              <div class="attendance-player-item">
                <input type="checkbox" class="attendance-checkbox team-2-checkbox" data-team="2" data-player-id="${member.id}" data-player-name="${member.name}">
                <div class="attendance-player-info">
                  <div class="attendance-player-id">${member.id}</div>
                  <div class="attendance-player-name">${member.name}</div>
                </div>
              </div>
            `;
          });

          attendanceHtml += `
              </div>
            </div>
          `;

          $("#attendanceContent").html(attendanceHtml);
          
          // Add change event listeners to attendance checkboxes
          $(".attendance-checkbox").on("change", function() {
            updateStartMatchButton();
            updateSelectAllState();
          });
          
          // Add select all functionality
          $(".select-all-checkbox").on("change", function() {
            const team = $(this).data("team");
            const isChecked = $(this).prop("checked");
            
            if (team === "1" || team === 1) {
              $(".team-1-checkbox").prop("checked", isChecked);
            } else if (team === "2" || team === 2) {
              $(".team-2-checkbox").prop("checked", isChecked);
            }
            
            updateStartMatchButton();
          });
          
          updateStartMatchButton();
        }

        function updateSelectAllState() {
          // Update Team 1 select all state
          const team1Total = $(".team-1-checkbox").length;
          const team1Checked = $(".team-1-checkbox:checked").length;
          $("#selectAllTeam1").prop("checked", team1Total > 0 && team1Checked === team1Total);
          
          // Update Team 2 select all state  
          const team2Total = $(".team-2-checkbox").length;
          const team2Checked = $(".team-2-checkbox:checked").length;
          $("#selectAllTeam2").prop("checked", team2Total > 0 && team2Checked === team2Total);
        }

        function updateStartMatchButton() {
          const checkedBoxes = $(".attendance-checkbox:checked").length;
          const startBtn = $("#startMatchBtn");
          
          if (checkedBoxes > 0) {
            startBtn.prop("disabled", false);
            startBtn.text(`Start Match (${checkedBoxes} players present)`);
          } else {
            startBtn.prop("disabled", true);
            startBtn.text("Start Match (No players selected)");
          }
        }

        function closeAttendancePopup(reset) {
          $("#attendancePopup").removeClass("active");
          // By default, reset state unless explicitly passed false
          if (reset !== false) {
            currentMatchId = null;
            attendanceData = { team1: [], team2: [] };
          }
        }

        function proceedWithMatch() {
          // Collect attendance data
          attendanceData.team1 = [];
          attendanceData.team2 = [];
          
          $(".attendance-checkbox:checked").each(function() {
            const team = $(this).data("team");
            const playerId = $(this).data("player-id");
            const playerName = $(this).data("player-name");
            
            const playerData = { id: playerId, name: playerName };
            
            if (team === "1" || team === 1) {
              attendanceData.team1.push(playerData);
            } else if (team === "2" || team === 2) {
              attendanceData.team2.push(playerData);
            }
          });
          
          // Preserve match id before closing the popup
          const matchIdToStart = currentMatchId;

          // Close attendance popup
          closeAttendancePopup(false); // don't reset state when proceeding
          
          // Now proceed with the original match start logic
          $("#referee-matches-list, #referee-stat-cards").addClass("hidden");
          $("#admin-start-match-root").removeClass("hidden");
          renderAdminStartMatch(matchIdToStart);
        }

        // Expose functions globally for inline handlers
        window.proceedWithMatch = proceedWithMatch;
        window.closeAttendancePopup = closeAttendancePopup;

        function renderAdminStartMatch(matchId) {
          const match = allMatches.find((m) => m.id == matchId);
          if (!match) {
            $("#admin-start-match-root").html(
              '<div class="text-red-400">Match not found!</div>'
            );
            return;
          }

          console.log("Match data:", match);
          console.log("Team1 ID:", match.team1Id);
          console.log("Team2 ID:", match.team2Id);

          // Show loading state while fetching team data
          $("#admin-start-match-root").html(
            '<div class="text-white text-center py-10">Loading team data...</div>'
          );

          // Check if we have attendance data (from attendance popup)
          if (attendanceData.team1.length > 0 || attendanceData.team2.length > 0) {
            // Use attendance data instead of fetching all team members
            fetchTeamMembers(
              match.team1Id,
              match.team2Id,
              function (team1Data, team2Data) {
                console.log("Team 1 data received:", team1Data);
                console.log("Team 2 data received:", team2Data);
                console.log("Using attendance data - Team 1:", attendanceData.team1);
                console.log("Using attendance data - Team 2:", attendanceData.team2);

                // Get team objects with ONLY present members from attendance
                const team1 = {
                  name: team1Data.name || match.team1Name || "Unknown Team",
                  members: attendanceData.team1, // Use only present players
                  jersey_image_url: team1Data.jersey_image_url || null,
                };
                const team2 = {
                  name: team2Data.name || match.team2Name || "Unknown Team",
                  members: attendanceData.team2, // Use only present players
                  jersey_image_url: team2Data.jersey_image_url || null,
                };

                console.log("Final team1 object with attendance:", team1);
                console.log("Final team2 object with attendance:", team2);

                renderMatchInterface(match, team1, team2);
              }
            );
          } else {
            // Fallback to original behavior (fetch all team members)
            fetchTeamMembers(
              match.team1Id,
              match.team2Id,
              function (team1Data, team2Data) {
                console.log("Team 1 data received:", team1Data);
                console.log("Team 2 data received:", team2Data);

                // Get team objects with all members (original behavior)
                const team1 = {
                  name: team1Data.name || match.team1Name || "Unknown Team",
                  members: team1Data.members || [],
                  jersey_image_url: team1Data.jersey_image_url || null,
                };
                const team2 = {
                  name: team2Data.name || match.team2Name || "Unknown Team",
                  members: team2Data.members || [],
                  jersey_image_url: team2Data.jersey_image_url || null,
                };

                console.log("Final team1 object:", team1);
                console.log("Final team2 object:", team2);

                renderMatchInterface(match, team1, team2);
              }
            );
          }
        }

        function fetchTeamMembers(team1Id, team2Id, callback) {
          $.ajax({
            url: your_plugin_ajax_object.ajax_url,
            type: "POST",
            data: {
              action: "fetch_team_members",
              nonce: your_plugin_ajax_object.nonce,
              team1_id: team1Id,
              team2_id: team2Id,
            },
            success: function (response) {
              console.log("Team members AJAX response:", response);
              console.log("Response data:", response.data);
              if (response.data && response.data.team1) {
                console.log("Team1 response data:", response.data.team1);
                console.log("Team1 members:", response.data.team1.members);
              }
              if (response.data && response.data.team2) {
                console.log("Team2 response data:", response.data.team2);
                console.log("Team2 members:", response.data.team2.members);
              }
              if (response.success) {
                callback(response.data.team1, response.data.team2);
              } else {
                console.error("Failed to fetch team members:", response.data);
                // Fallback with empty members
                callback(
                  { name: "Team 1", members: [] },
                  { name: "Team 2", members: [] }
                );
              }
            },
            error: function () {
              console.error("AJAX error when fetching team members");
              // Fallback with empty members
              callback(
                { name: "Team 1", members: [] },
                { name: "Team 2", members: [] }
              );
            },
          });
        }

        // Global table renderer so both main flow and edit popup can reuse it
        function renderPlayerEventsTable(
          $container,
          playerEvents,
          teamGoals
        ) {
          const goalColumnCount = Math.max(8, (teamGoals || []).length);
          // Build a quick id->name map from the team members attached to this card
          const teamMembers = $container.closest('.team-scoring-card').data('teamMembers') || [];
          const nameMap = {};
          teamMembers.forEach(m => { nameMap[m.id] = m.name; });

          // Helper to count goals for a player
          function countGoalsFor(playerId) {
            return (teamGoals || []).filter(pid => pid == playerId).length;
          }

          // Predefine standard reasons per card type
          const reasons = {
            blue: [
              { code: 'time_wasting', label: 'Time wasting' },
              { code: 'encroachment', label: 'Encroachment' },
              { code: 'dissent', label: 'Dissent' },
              { code: 'unsporting', label: 'Unsporting behavior' },
              { code: 'other', label: 'Other...' }
            ],
            yellow: [
              { code: 'unsporting', label: 'Unsporting behavior' },
              { code: 'dissent', label: 'Dissent' },
              { code: 'persistence', label: 'Persistent infringement' },
              { code: 'delay', label: 'Delaying restart' },
              { code: 'other', label: 'Other...' }
            ],
            red: [
              { code: 'serious_foul', label: 'Serious foul play' },
              { code: 'violent', label: 'Violent conduct' },
              { code: 'spitting', label: 'Spitting' },
              { code: 'denying_goal', label: 'Denying goal-scoring opp.' },
              { code: 'other', label: 'Other...' }
            ]
          };

          let table = `
              <div class="player-events-table">
                <table class="min-w-full text-xs text-white border border-white/10 rounded-lg overflow-hidden mt-6">
                  <thead>
                    <tr>
                      <th class="px-2 py-1 border-b border-white/10">Player ID</th>
                      <th class="px-2 py-1 border-b border-white/10">Player Name</th>
                      <th class="px-2 py-1 border-b border-white/10">Total Goals</th>
                      ${[...Array(goalColumnCount)]
                        .map(
                          (_, i) =>
                            `<th class="px-2 py-1 border-b border-white/10">${
                              i + 1
                            }</th>`
                        )
                        .join("")}
                      <th class="px-2 py-1 border-b border-white/10 text-blue-400">Blue</th>
                      <th class="px-2 py-1 border-b border-white/10 text-yellow-400">Yellow</th>
                      <th class="px-2 py-1 border-b border-white/10 text-red-400">Red</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${playerEvents
                      .map(
                        (ev) => `
                      <tr>
                        <td class="px-2 py-1 border-b border-white/10 text-center">${
                          ev.id
                        }</td>
                        <td class="px-2 py-1 border-b border-white/10 text-center">${
                          nameMap[ev.id] ? nameMap[ev.id] : ''
                        }</td>
                        <td class="px-2 py-1 border-b border-white/10 text-center">${countGoalsFor(ev.id)}</td>
                        ${Array.from({ length: goalColumnCount }, (_, i) => {
                          const scorerId = (teamGoals || [])[i];
                          return `<td class="px-2 py-1 border-b border-white/10 text-center">
                                <label class="custom-checkbox">
                                  <input type="checkbox" data-player-id="${
                                    ev.id
                                  }" data-goal-index="${i}" class="goal-checkbox" ${
                            scorerId && scorerId == ev.id ? "checked" : ""
                          }>
                                  <span></span>
                                </label>
                              </td>`;
                        }).join("")}
                        <td class="px-2 py-1 border-b border-white/10 text-center">
                          <div class="reason-inline flex items-center justify-center gap-2">
                            <select class="reason-select text-xs rounded px-1 py-0.5 ${ev.blue ? '' : 'hidden'}" data-player-id="${ev.id}" data-card-type="blue">
                              <option value="" ${!ev.blue_reason_code ? 'selected' : ''} disabled>Choose reason</option>
                              ${reasons.blue.map(r => `<option value="${r.code}" ${ev.blue_reason_code===r.code ? 'selected' : ''}>${r.label}</option>`).join('')}
                            </select>
                            <input type="text" placeholder="Enter reason" class="reason-other-input text-xs px-2 py-1 rounded bg-white/10 border border-white/20 text-white ${ev.blue && ev.blue_reason_code==='other' ? '' : 'hidden'}" data-player-id="${ev.id}" data-card-type="blue" value="${ev.blue_reason_code==='other' ? (ev.blue_reason_text||'') : ''}">
                            <label class="custom-checkbox blue-checkbox">
                              <input type="checkbox" data-player-id="${ev.id}" data-card-type="blue" class="card-checkbox" ${ev.blue ? "checked" : ""}>
                              <span></span>
                            </label>
                          </div>
                        </td>
                        <td class="px-2 py-1 border-b border-white/10 text-center">
                          <div class="reason-inline flex items-center justify-center gap-2">
                            <select class="reason-select text-xs rounded px-1 py-0.5 ${ev.yellow ? '' : 'hidden'}" data-player-id="${ev.id}" data-card-type="yellow">
                              <option value="" ${!ev.yellow_reason_code ? 'selected' : ''} disabled>Choose reason</option>
                              ${reasons.yellow.map(r => `<option value="${r.code}" ${ev.yellow_reason_code===r.code ? 'selected' : ''}>${r.label}</option>`).join('')}
                            </select>
                            <input type="text" placeholder="Enter reason" class="reason-other-input text-xs px-2 py-1 rounded bg-white/10 border border-white/20 text-white ${ev.yellow && ev.yellow_reason_code==='other' ? '' : 'hidden'}" data-player-id="${ev.id}" data-card-type="yellow" value="${ev.yellow_reason_code==='other' ? (ev.yellow_reason_text||'') : ''}">
                            <label class="custom-checkbox yellow-checkbox">
                              <input type="checkbox" data-player-id="${ev.id}" data-card-type="yellow" class="card-checkbox" ${ev.yellow ? "checked" : ""}>
                              <span></span>
                            </label>
                          </div>
                        </td>
                        <td class="px-2 py-1 border-b border-white/10 text-center">
                          <div class="reason-inline flex items-center justify-center gap-2">
                            <select class="reason-select text-xs rounded px-1 py-0.5 ${ev.red ? '' : 'hidden'}" data-player-id="${ev.id}" data-card-type="red">
                              <option value="" ${!ev.red_reason_code ? 'selected' : ''} disabled>Choose reason</option>
                              ${reasons.red.map(r => `<option value="${r.code}" ${ev.red_reason_code===r.code ? 'selected' : ''}>${r.label}</option>`).join('')}
                            </select>
                            <input type="text" placeholder="Enter reason" class="reason-other-input text-xs px-2 py-1 rounded bg-white/10 border border-white/20 text-white ${ev.red && ev.red_reason_code==='other' ? '' : 'hidden'}" data-player-id="${ev.id}" data-card-type="red" value="${ev.red_reason_code==='other' ? (ev.red_reason_text||'') : ''}">
                            <label class="custom-checkbox red-checkbox">
                              <input type="checkbox" data-player-id="${ev.id}" data-card-type="red" class="card-checkbox" ${ev.red ? "checked" : ""}>
                              <span></span>
                            </label>
                          </div>
                        </td>
                      </tr>
                    `
                      )
                      .join("")}
                  </tbody>
                </table>
              </div>
          `;
          $container.html(table);

          // Add event listeners for goal checkboxes
          $container.find(".goal-checkbox").on("change", function () {
            const playerId = $(this).data("player-id");
            const goalIndex = $(this).data("goal-index");
            const isChecked = $(this).prop("checked");

            let teamGoalsLocal = $container
              .closest(".team-scoring-card")
              .data("teamGoals") || [];

            if (isChecked) {
              // Add goal at specific index
              teamGoalsLocal[goalIndex] = playerId;
            } else {
              // Remove goal at specific index
              teamGoalsLocal[goalIndex] = undefined;
            }

            // Update team goals data
            $container
              .closest(".team-scoring-card")
              .data("teamGoals", teamGoalsLocal);

            // Re-render table to reflect changes
            const playerEventsLocal = $container
              .closest(".team-scoring-card")
              .data("playerEvents") || [];
            renderPlayerEventsTable($container, playerEventsLocal, teamGoalsLocal);
          });

          // Add event listeners for card checkboxes
          $container.find(".card-checkbox").on("change", function () {
            const playerId = $(this).data("player-id");
            const cardType = $(this).data("card-type");
            const isChecked = $(this).prop("checked");

            let playerEventsLocal = $container
              .closest(".team-scoring-card")
              .data("playerEvents") || [];
            let player = playerEventsLocal.find((ev) => ev.id == playerId);

            if (player) {
              player[cardType] = isChecked;
              // Reset reason fields when unchecked
              if (!isChecked) {
                player[cardType + '_reason_code'] = '';
                player[cardType + '_reason_text'] = '';
              }

              // Update player events data
              $container
                .closest(".team-scoring-card")
                .data("playerEvents", playerEventsLocal);
            }

            // Toggle reason UI visibility (dropdown and optional other input)
            const cell = $(this).closest('td');
            const reasonSelect = cell.find('select.reason-select[data-card-type="' + cardType + '"][data-player-id="' + playerId + '"]');
            const otherInput = cell.find('input.reason-other-input[data-card-type="' + cardType + '"][data-player-id="' + playerId + '"]');
            if (isChecked) {
              reasonSelect.removeClass('hidden');
              // show other input only when 'other' is currently selected
              if ((player && player[cardType + '_reason_code']) === 'other') {
                otherInput.removeClass('hidden');
              }
            } else {
              reasonSelect.addClass('hidden');
              otherInput.addClass('hidden');
            }
          });

          // Reason select changes
          $container.find('.reason-select').on('change', function() {
            const playerId = $(this).data('player-id');
            const cardType = $(this).data('card-type');
            const code = $(this).val();
            const cell = $(this).closest('td');
            const otherInput = cell.find('.reason-other-input');

            let playerEventsLocal = $container.closest('.team-scoring-card').data('playerEvents') || [];
            let player = playerEventsLocal.find((ev) => ev.id == playerId);
            if (player) {
              player[cardType + '_reason_code'] = code;
              if (code === 'other') {
                otherInput.removeClass('hidden');
                // keep existing text if any
              } else {
                otherInput.addClass('hidden');
                // Set text to the label of the selected option
                const label = $(this).find('option:selected').text();
                player[cardType + '_reason_text'] = label;
              }
              $container.closest('.team-scoring-card').data('playerEvents', playerEventsLocal);
            }
          });

          // Reason other input changes
          $container.find('.reason-other-input').on('input', function() {
            const playerId = $(this).data('player-id');
            const cardType = $(this).data('card-type');
            const text = $(this).val();
            let playerEventsLocal = $container.closest('.team-scoring-card').data('playerEvents') || [];
            let player = playerEventsLocal.find((ev) => ev.id == playerId);
            if (player) {
              player[cardType + '_reason_text'] = text;
              $container.closest('.team-scoring-card').data('playerEvents', playerEventsLocal);
            }
          });
        }

        // Wrapper to render into an arbitrary container, with optional initialData (from saved meta)
        function renderMatchInterfaceInto(containerSelector, match, team1, team2, initialData) {
          // Render as usual, but place generated HTML into the given container
          const $container = $(containerSelector);
          // We temporarily override #admin-start-match-root target by injecting HTML into this container
          // Save reference to append area
          const originalRoot = $('#admin-start-match-root');
          const tempRoot = $('<div></div>');
          originalRoot.append(tempRoot);
          // Call existing renderer which writes into #admin-start-match-root
          renderMatchInterface(match, team1, team2);
          // Move produced content into our target container
          $container.html(originalRoot.children().detach());

          // Prefill with initialData if provided
          if (initialData) {
            try {
              // initialData is expected to include score_data JSON string and other fields
              const data = initialData;
              if (data.score_data) {
                const parsed = typeof data.score_data === 'string' ? JSON.parse(data.score_data) : data.score_data;
                
                // Preserve existing attendance data for editing
                if (parsed.team1 && parsed.team1.attendance) {
                  existingAttendanceData.team1 = parsed.team1.attendance;
                }
                if (parsed.team2 && parsed.team2.attendance) {
                  existingAttendanceData.team2 = parsed.team2.attendance;
                }
                console.log('Loaded existing attendance data for editing:', existingAttendanceData);
                
                // Apply goals/cards to UI state
                const $cards = $container.find('.team-scoring-card');
                function applyTeam(cardIdx, teamObj) {
                  const $card = $cards.eq(cardIdx);
                  let playerEvents = $card.data('playerEvents') || [];
                  let teamGoals = [];
                  // Robustly handle goals array which may contain nulls or be an array of ids
                  const rawGoals = Array.isArray(teamObj.goals) ? teamObj.goals : [];
                  if (rawGoals.length && typeof rawGoals[0] === 'object') {
                    rawGoals.forEach(g => {
                      if (g && g.goalIndex != null && g.playerId != null) {
                        const idx = parseInt(g.goalIndex, 10);
                        if (!isNaN(idx) && idx > 0) {
                          teamGoals[idx - 1] = g.playerId;
                        }
                      }
                    });
                  } else {
                    // Treat as array of playerIds possibly with holes/nulls
                    rawGoals.forEach((pid, idx) => {
                      if (pid != null && pid !== '') teamGoals[idx] = pid;
                    });
                  }
                  (teamObj.cards || []).forEach(c => {
                    let p = playerEvents.find(ev => ev.id == c.playerId);
                    if (!p) {
                      p = { id: c.playerId, blue:false,yellow:false,red:false, blue_reason_code:'',blue_reason_text:'',yellow_reason_code:'',yellow_reason_text:'',red_reason_code:'',red_reason_text:'' };
                      playerEvents.push(p);
                    }
                    p.blue = !!c.blue; p.yellow = !!c.yellow; p.red = !!c.red;
                    p.blue_reason_code = c.blue_reason_code || ''; p.blue_reason_text = c.blue_reason_text || '';
                    p.yellow_reason_code = c.yellow_reason_code || ''; p.yellow_reason_text = c.yellow_reason_text || '';
                    p.red_reason_code = c.red_reason_code || ''; p.red_reason_text = c.red_reason_text || '';
                  });
                  $card.data('playerEvents', playerEvents);
                  $card.data('teamGoals', teamGoals);
                  const $tableContainer = $card.find('.events-table-container');
                  renderPlayerEventsTable($tableContainer, playerEvents, teamGoals);
                }
                if (parsed.team1) applyTeam(0, parsed.team1);
                if (parsed.team2) applyTeam(1, parsed.team2);
              }
              // Prefill summary fields
              if (data.final_score) $container.find('input[name="final_score"]').val(data.final_score);
              if (data.first_half_fouls) $container.find('input[name="first_half_fouls"]').val(data.first_half_fouls);
              if (data.second_half_fouls) $container.find('input[name="second_half_fouls"]').val(data.second_half_fouls);
              if (data.caution_desc) $container.find('textarea[name="caution_desc"]').val(data.caution_desc);
              if (data.additional_notes) $container.find('textarea[name="additional_notes"]').val(data.additional_notes);
            } catch(e) {
              console.warn('Failed to prefill score data', e);
            }
          }

          // Override submit to keep popup open and refresh list on save
          $container.find('#matchSummaryForm').off('submit').on('submit', function(e){
            e.preventDefault();
            // Reuse the save logic by temporarily moving DOM back into original root to use existing handler
            const form = this;
            // Call original save handler by triggering it programmatically
            // Extract final payload same as original
            const finalScore = form.final_score.value;
            const firstHalfFouls = form.first_half_fouls.value;
            const secondHalfFouls = form.second_half_fouls.value;
            const cautionDesc = form.caution_desc.value;
            const additionalNotes = form.additional_notes.value;

            const $cards = $container.find('.team-scoring-card');
            const team1Card = $cards.eq(0);
            const team2Card = $cards.eq(1);
            function getTeamScoreData($card, teamId) {
              const goals = ($card.data('teamGoals') || []).map((pid, idx) => ({ playerId: pid, goalIndex: idx + 1 }));
              const cardsArr = ($card.data('playerEvents') || []).map((ev) => ({
                playerId: ev.id,
                blue: !!ev.blue,
                yellow: !!ev.yellow,
                red: !!ev.red,
                blue_reason_code: ev.blue ? (ev.blue_reason_code || '') : '',
                blue_reason_text: ev.blue ? (ev.blue_reason_text || '') : '',
                yellow_reason_code: ev.yellow ? (ev.yellow_reason_code || '') : '',
                yellow_reason_text: ev.yellow ? (ev.yellow_reason_text || '') : '',
                red_reason_code: ev.red ? (ev.red_reason_code || '') : '',
                red_reason_text: ev.red ? (ev.red_reason_text || '') : ''
              }));
              
              // Add attendance data if available
              let attendance = [];
              if (attendanceData && attendanceData.team1 && attendanceData.team2) {
                if (teamId == match.team1Id) {
                  attendance = attendanceData.team1.map(player => player.id);
                } else if (teamId == match.team2Id) {
                  attendance = attendanceData.team2.map(player => player.id);
                }
                console.log(`[SAVE] Adding attendance for team ${teamId}:`, attendance);
              }
              
              return { 
                id: teamId, 
                goals, 
                cards: cardsArr, 
                attendance: attendance // Add attendance to score data
              };
            }
            const scoreData = JSON.stringify({
              team1: getTeamScoreData(team1Card, match.team1Id),
              team2: getTeamScoreData(team2Card, match.team2Id),
            });

            $.ajax({
              url: your_plugin_ajax_object.ajax_url,
              type: 'POST',
              data: {
                action: 'save_soccer_match_summary',
                nonce: your_plugin_ajax_object.nonce,
                match_id: match.id,
                final_score: finalScore,
                first_half_fouls: firstHalfFouls,
                second_half_fouls: secondHalfFouls,
                caution_desc: cautionDesc,
                additional_notes: additionalNotes,
                score_data: scoreData,
              },
              success: function (response) {
                if (response.success) {
                  showMessage('Match summary updated!', 'success');
                  loadRefereeMatches();
                  // keep popup open or closeclose for now
                  closeScoreEditPopup();
                } else {
                  showMessage(response.data && response.data.message ? response.data.message : 'Failed to save match summary.', 'error');
                }
              },
              error: function () { showMessage('Error saving match summary.', 'error'); }
            });
          });
        }

        // Existing renderer, kept intact for start-match flow
        function renderMatchInterface(match, team1, team2) {
          const matchId = match.id; // Store matchId for use in form handlers
          const team1Name = team1.name;
          const team2Name = team2.name;

          function buildDatalistOptions(members) {
            // Ensure members is an array and has valid data
            if (!members || !Array.isArray(members)) {
              console.log("Members is not a valid array:", members);
              return "";
            }
            console.log("Building datalist options for members:", members);
            const options = members
              .filter((member) => member && member.id && member.name) // Filter out invalid members
              .map(
                (member) =>
                  `<option value="${member.id}">${member.name}</option>`
              )
              .join("");
            console.log("Generated datalist options:", options);
            return options;
          }

          const teamIconSVG = (jerseyUrl, teamName) => `
            <img src="${
              jerseyUrl || "https://via.placeholder.com/80"
            }" alt="${teamName} Jersey" class="w-20 h-20 rounded-lg object-cover mr-4 border-2 border-white/20 team-jersey-image" onclick="openImagePopup('${
            jerseyUrl || "https://via.placeholder.com/80"
          }', '${teamName} Jersey')">
          `;

          const cardFormHTML = (teamNum, datalistOptions) => `
            <form class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 mt-4">
              <input type="text" list="playerIdsTeam${teamNum}" class="w-full sm:w-32 px-3 py-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Player ID" />
              <datalist id="playerIdsTeam${teamNum}">${datalistOptions}</datalist>
              <button type="button" class="w-full sm:w-auto px-3 py-2 rounded-lg bg-green-500 text-white font-semibold hover:bg-green-600 transition text-xs">Goal</button>
              <button type="button" class="w-full sm:w-auto px-3 py-2 rounded-lg bg-blue-500 text-white font-semibold hover:bg-blue-600 transition text-xs">Blue Card</button>
              <button type="button" class="w-full sm:w-auto px-3 py-2 rounded-lg bg-yellow-500 text-white font-semibold hover:bg-yellow-600 transition text-xs">Yellow Card</button>
              <button type="button" class="w-full sm:w-auto px-3 py-2 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 transition text-xs">Red Card</button>
            </form>
        `;

          // use global renderPlayerEventsTable

          const mainHtml = `
            <div class="space-y-8">
                <!-- Team 1 Card -->
                <div class="card-hover glassmorphism team-scoring-card rounded-2xl p-6 border border-white/10 flex flex-col">
                    <h3 class="text-xl font-bold text-white flex items-center">${teamIconSVG(
                      team1.jersey_image_url,
                      team1Name
                    )}<span class="ml-1">${team1Name}</span></h3>
                    ${cardFormHTML(
                      1,
                      buildDatalistOptions(team1.members || [])
                    )}
                    <div class="events-table-container flex-grow"></div>
                </div>

                <!-- Team 2 Card -->
                <div class="card-hover glassmorphism team-scoring-card rounded-2xl p-6 border border-white/10 flex flex-col">
                    <h3 class="text-xl font-bold text-white flex items-center">${teamIconSVG(
                      team2.jersey_image_url,
                      team2Name
                    )}<span class="ml-1">${team2Name}</span></h3>
                    ${cardFormHTML(
                      2,
                      buildDatalistOptions(team2.members || [])
                    )}
                    <div class="events-table-container flex-grow"></div>
                </div>

                <!-- Match Summary Card -->
                <div class="card-hover glassmorphism match-summary-card p-6 rounded-2xl">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2a4 4 0 014-4h2a4 4 0 014 4v2M9 17H7a4 4 0 01-4-4V7a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4h-2"></path></svg>
                        Match Summary
                    </h3>
                    <form id="matchSummaryForm" class="flex flex-col gap-4">
                        <div><label class="block text-white font-semibold mb-1">Final Score</label><input type="text" name="final_score" class="w-full px-3 py-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400 text-sm focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="e.g. 3-2" required></div>
                        <div><label class="block text-white font-semibold mb-1">1st Half Fouls</label><input type="text" name="first_half_fouls" class="w-full px-3 py-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400 text-sm focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="Enter fouls in 1st half"></div>
                        <div><label class="block text-white font-semibold mb-1">2nd Half Fouls</label><input type="text" name="second_half_fouls" class="w-full px-3 py-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400 text-sm focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="Enter fouls in 2nd half"></div>
                        <div><label class="block text-white font-semibold mb-1">Caution Descriptions</label><textarea name="caution_desc" rows="2" class="w-full px-3 py-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400 text-sm focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="Describe any cautions..."></textarea></div>
                        <div><label class="block text-white font-semibold mb-1">Additional Notes</label><textarea name="additional_notes" rows="2" class="w-full px-3 py-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400 text-sm focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="Any additional notes..."></textarea></div>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-green-500 text-white font-semibold hover:bg-green-600 transition text-base mt-2">Save Match</button>
                    </form>
                </div>
            </div>`;

          $("#admin-start-match-root").html(mainHtml);

          $(".team-scoring-card").each(function (idx) {
            const $card = $(this);
            // Pre-populate events with all present players so table shows everyone
            const members = idx === 0 ? (team1.members || []) : (team2.members || []);
            const initialEvents = members.map(m => ({
              id: m.id,
              blue: false,
              yellow: false,
              red: false,
              blue_reason_code: '',
              blue_reason_text: '',
              yellow_reason_code: '',
              yellow_reason_text: '',
              red_reason_code: '',
              red_reason_text: ''
            }));
            $card.data("playerEvents", initialEvents);
            $card.data("teamGoals", []);
            // Attach team members for name lookups
            $card.data('teamMembers', idx === 0 ? (team1.members || []) : (team2.members || []));
            const $tableContainer = $card.find(".events-table-container");

            renderPlayerEventsTable(
              $tableContainer,
              $card.data("playerEvents"),
              $card.data("teamGoals")
            );

            $card.find("button").on("click", function (e) {
              e.preventDefault();
              const $input = $card.find('input[type="text"]');
              const playerId = $input.val().trim();

              if (!playerId) {
                showMessage("Please enter a player ID.", "error");
                return;
              }

              // Validate that the player ID exists in the team's member list
              const teamIndex = $(".team-scoring-card").index($card) + 1;
              const teamMembers =
                teamIndex === 1 ? team1.members : team2.members;
              const validPlayer = teamMembers.find(
                (member) => member.id == playerId
              );

              if (!validPlayer) {
                showMessage(
                  "Invalid player ID. Please select a player from the team roster.",
                  "error"
                );
                return;
              }

              let playerEvents = $card.data("playerEvents");
              let teamGoals = $card.data("teamGoals");
        let player = playerEvents.find((ev) => ev.id == playerId); // Use == for loose comparison
              if (!player) {
                player = {
                  id: playerId,
                  blue: false,
                  yellow: false,
                  red: false,
          blue_reason_code: '',
          blue_reason_text: '',
          yellow_reason_code: '',
          yellow_reason_text: '',
          red_reason_code: '',
          red_reason_text: '',
                };
                playerEvents.push(player);
              }

              const buttonText = $(this).text();
              if (buttonText.includes("Goal")) {
                teamGoals.push(playerId);
              } else if (buttonText.includes("Blue")) {
                player.blue = true;
              } else if (buttonText.includes("Yellow")) {
                player.yellow = true;
              } else if (buttonText.includes("Red")) {
                player.red = true;
              }

              renderPlayerEventsTable($tableContainer, playerEvents, teamGoals);
              $input.val("");
            });
          });

          $("#matchSummaryForm").on("submit", function (e) {
            e.preventDefault();
            const finalScore = this.final_score.value;
            const firstHalfFouls = this.first_half_fouls.value;
            const secondHalfFouls = this.second_half_fouls.value;
            const cautionDesc = this.caution_desc.value;
            const additionalNotes = this.additional_notes.value;

            const $cards = $(".team-scoring-card");
            const team1Card = $cards.eq(0);
            const team2Card = $cards.eq(1);

            function getTeamScoreData($card, teamId) {
              const goals = ($card.data("teamGoals") || []).map((pid, idx) => ({
                playerId: pid,
                goalIndex: idx + 1,
              }));
              const cardsArr = ($card.data("playerEvents") || []).map((ev) => ({
                playerId: ev.id,
                blue: !!ev.blue,
                yellow: !!ev.yellow,
                red: !!ev.red,
                blue_reason_code: ev.blue ? (ev.blue_reason_code || '') : '',
                blue_reason_text: ev.blue ? (ev.blue_reason_text || '') : '',
                yellow_reason_code: ev.yellow ? (ev.yellow_reason_code || '') : '',
                yellow_reason_text: ev.yellow ? (ev.yellow_reason_text || '') : '',
                red_reason_code: ev.red ? (ev.red_reason_code || '') : '',
                red_reason_text: ev.red ? (ev.red_reason_text || '') : ''
              }));
              
              // Add attendance data if available (preserve existing when editing)
              let attendance = [];
              console.log(`[DEBUG] Processing team ${teamId}, existingAttendanceData:`, existingAttendanceData);
              
              if (existingAttendanceData && (existingAttendanceData.team1.length > 0 || existingAttendanceData.team2.length > 0)) {
                // Use existing attendance data when editing - preserve it exactly
                if (teamId == match.team1Id) {
                  attendance = existingAttendanceData.team1;
                } else if (teamId == match.team2Id) {
                  attendance = existingAttendanceData.team2;
                }
                console.log(`[EDIT] Using existing attendance for team ${teamId}:`, attendance);
              } else if (attendanceData && attendanceData.team1 && attendanceData.team2 && (attendanceData.team1.length > 0 || attendanceData.team2.length > 0)) {
                // Use new attendance data from attendance popup (for new matches)
                if (teamId == match.team1Id) {
                  attendance = attendanceData.team1.map(player => player.id);
                } else if (teamId == match.team2Id) {
                  attendance = attendanceData.team2.map(player => player.id);
                }
                console.log(`[NEW] Using new attendance for team ${teamId}:`, attendance);
              } else {
                // For editing: Don't include attendance field at all if no data
                // This prevents overwriting existing data with empty arrays
                console.log(`[SKIP] No attendance data for team ${teamId} - skipping attendance field`);
                return { 
                  id: teamId, 
                  goals, 
                  cards: cardsArr
                  // No attendance field - this prevents overwriting existing data
                };
              }
              
              return { 
                id: teamId, 
                goals, 
                cards: cardsArr, 
                attendance: attendance // Add attendance to score data
              };
            }

            const scoreData = JSON.stringify({
              team1: getTeamScoreData(team1Card, match.team1Id),
              team2: getTeamScoreData(team2Card, match.team2Id),
            });

            $.ajax({
              url: your_plugin_ajax_object.ajax_url,
              type: "POST",
              data: {
                action: "save_soccer_match_summary",
                nonce: your_plugin_ajax_object.nonce,
                match_id: matchId,
                final_score: finalScore,
                first_half_fouls: firstHalfFouls,
                second_half_fouls: secondHalfFouls,
                caution_desc: cautionDesc,
                additional_notes: additionalNotes,
                score_data: scoreData,
              },
              success: function (response) {
                if (response.success) {
                  showMessage("Match summary saved!", "success");
                  loadRefereeMatches();
                  $("#admin-start-match-root").addClass("hidden").html("");
                  $("#referee-matches-list, #referee-stat-cards").removeClass(
                    "hidden"
                  );
                } else {
                  showMessage(
                    response.data.message || "Failed to save match summary.",
                    "error"
                  );
                }
              },
              error: function () {
                showMessage("Error saving match summary.", "error");
              },
            });
          });
        }

        function showMessage(message, type) {
          const alertClass =
            type === "error"
              ? "bg-red-500/80"
              : type === "success"
              ? "bg-green-500/80"
              : "bg-blue-500/80";
          const messageHtml = `<div class="fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-medium z-50 ${alertClass}" role="alert">
                                <span class="block sm:inline">${message}</span>
                            </div>`;
          const $message = $(messageHtml).appendTo("body");
          setTimeout(function () {
            $message.fadeOut(500, function () {
              $(this).remove();
            });
          }, 3000);
        }

        // Initial load
        loadRefereeMatches();
      });
    </script>
  </body>
</html>
