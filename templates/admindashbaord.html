<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Team & Matches</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#6366f1",
            secondary: "#8b5cf6",
          },
          zIndex: {
            '100000': '100000',
          },
        },
      },
    };
  </script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

    body {
      font-family: "Inter", sans-serif;
    }

    .glassmorphism {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card-hover {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .animate-float {
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0px);
      }

      50% {
        transform: translateY(-20px);
      }
    }

    .sidebar-item {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      border-radius: 12px;
      margin-bottom: 4px;
    }

    .sidebar-item::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg,
          transparent,
          rgba(255, 255, 255, 0.15),
          rgba(99, 102, 241, 0.1),
          transparent);
      transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .sidebar-item:hover::before {
      left: 100%;
    }

    .sidebar-item:hover {
      transform: translateX(8px);
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15);
    }

    .sidebar-item.active {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2)) !important;
      color: white !important;
      border: 1px solid rgba(99, 102, 241, 0.3);
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2);
    }

    .sidebar-item.active i {
      color: #6366f1 !important;
    }

    .sidebar-item i {
      transition: all 0.3s ease;
      color: rgba(255, 255, 255, 0.7);
    }

    .sidebar-item:hover i {
      color: #6366f1;
      transform: scale(1.1);
    }

    .pulse-ring {
      animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
    }

    @keyframes pulse-ring {
      0% {
        transform: scale(0.8);
      }

      40%,
      50% {
        opacity: 0;
      }

      100% {
        transform: scale(1.2);
        opacity: 0;
      }
    }

    /* Custom Scrollbar Styling */
    /* For Webkit browsers (Chrome, Safari) */
    ::-webkit-scrollbar {
      width: 10px;
      /* Width of the scrollbar */
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      /* Track color similar to glassmorphism */
      border-radius: 10px;
      /* Rounded corners for the track */
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(128, 90, 242, 0.6);
      /* Purple color for the thumb, slightly transparent */
      border-radius: 10px;
      /* Rounded corners for the thumb */
      border: 2px solid transparent;
      /* Creates padding around the thumb */
      background-clip: content-box;
      /* Ensures padding is respected */
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(99, 102, 241, 0.8);
      /* Darker purple on hover */
    }

    /* For Firefox */
    body {
      scrollbar-width: thin;
      /* 'auto' or 'thin' */
      scrollbar-color: rgba(128, 90, 242, 0.6) rgba(255, 255, 255, 0.05);
      /* thumb track */
    }

    .teamsList,
    .matchesList {
      /* Apply similar styling to specific scrollable containers */
      scrollbar-width: thin;
      scrollbar-color: rgba(128, 90, 242, 0.6) rgba(255, 255, 255, 0.05);
    }

    .teamsList::-webkit-scrollbar,
    .matchesList::-webkit-scrollbar {
      width: 10px;
    }

    .teamsList::-webkit-scrollbar-track,
    .matchesList::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .teamsList::-webkit-scrollbar-thumb,
    .matchesList::-webkit-scrollbar-thumb {
      background: rgba(128, 90, 242, 0.6);
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: content-box;
    }

    .teamsList::-webkit-scrollbar-thumb:hover,
    .matchesList::-webkit-scrollbar-thumb:hover {
      background: rgba(99, 102, 241, 0.8);
    }

    /* Custom Select Dropdown Styling */
    select {
      appearance: none;
      /* Remove default browser styling */
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='rgba(156, 163, 175, 1)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px;
      padding-right: 40px;
      /* Make room for the custom arrow */
    }

    /* Style the dropdown options */
    select option {
      background: #7945a3;
      /* Dark background for options */
      color: white;
      padding: 12px;
      border: none;
    }

    /* Firefox specific option styling */
    select option:checked {
      background: rgba(99, 102, 241, 0.3);
    }

    /* Hover effect for options (limited browser support) */
    select option:hover {
      background: rgba(99, 102, 241, 0.2);
    }

    /* Focus styling for select */
    select:focus {
      outline: none;
      border-color: transparent;
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.5);
    }

    /* Custom styling for disabled options */
    select option:disabled {
      color: rgba(156, 163, 175, 0.5);
      background: rgba(30, 41, 59, 0.5);
    }

    /* Hide number input spinners for Chrome, Safari, Edge, Opera */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* Responsive adjustments */
  @media (max-width: 1023px) {
      .sidebar {
        transform: translateX(-100%);
        /* Hidden by default on tablet and mobile */
        transition: transform 0.3s ease-in-out;
        position: fixed;
        /* Position fixed for overlay effect */
        top: 0;
        left: 0;
        max-height: 100vh;
        overflow-y: auto;
        z-index: 60;
        /* Ensure it's above other content */
        box-shadow: 2px 0 12px rgba(0,0,0,0.4);
        /* make it fully hidden and non-interactive until activated */
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }

      .sidebar.active {
        transform: translateX(0);
        /* Show when active */
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }

      .sidebar-overlay {
        display: none;
        /* Hidden by default */
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 50;
        /* Below sidebar, above main content */
      }

      /* Utility to disable body scroll when sidebar is open */
      body.no-scroll {
        overflow: hidden !important;
        height: 100vh; /* prevent touch scroll on mobile */
      }

      .main-content {
        width: 100%;
        /* Take full width on tablet and mobile */
        margin-left: 0;
        /* Remove left margin */
        transition: filter 0.3s ease-in-out;
        /* Smooth blur transition */
      }

      .sidebar.active ~ .main-content {
        filter: blur(4px);
        /* Blur main content when sidebar is active */
        pointer-events: none;
        /* Disable interactions when blurred */
      }

      .header h2,
      .header p {
        text-align: center;
        /* Center header text */
      }

      .stats-grid {
        grid-template-columns: repeat(1, minmax(0, 1fr));
        /* Stack stats on small screens */
      }

      .form-and-list-grid {
        grid-template-columns: repeat(1, minmax(0, 1fr));
        /* Stack form and list */
      }

      /* Hide desktop menu icon, show mobile menu icon */
      .desktop-menu-icon {
        display: none;
      }

      .mobile-menu-icon {
        display: block;
        /* Show hamburger on tablet and mobile */
      }
    }

  @media (min-width: 1024px) {

      /* Ensure mobile menu icon is hidden on larger screens */
      .mobile-menu-icon {
        display: none;
      }

      .sidebar {
        transform: translateX(0);
        /* Always visible on desktop */
        position: static;
        /* Not fixed */
      }
    }

    .custom-checkbox {
      display: inline-block;
      position: relative;
      width: 18px;
      height: 18px;
    }

    .custom-checkbox input[type="checkbox"] {
      opacity: 0;
      width: 18px;
      height: 18px;
      margin: 0;
      position: absolute;
      left: 0;
      top: 0;
      z-index: 2;
      cursor: not-allowed;
    }

    .custom-checkbox span {
      display: block;
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 2px solid #22c55e;
      /* Default green */
      background: transparent;
      box-sizing: border-box;
      position: absolute;
      left: 0;
      top: 0;
      z-index: 1;
      pointer-events: none;
    }

    /* Green (Goal) */
    .custom-checkbox input[type="checkbox"]:checked+span {
      background: #22c55e;
      border-color: #22c55e;
    }

    .custom-checkbox input[type="checkbox"]:checked+span::after {
      content: "";
      position: absolute;
      left: 4px;
      top: 0px;
      width: 5px;
      height: 10px;
      border: solid #fff;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
      pointer-events: none;
    }

    /* Blue Card */
    .blue-checkbox span {
      border-color: #3b82f6;
    }

    .blue-checkbox input[type="checkbox"]:checked+span {
      background: #3b82f6;
      border-color: #3b82f6;
    }

    /* Yellow Card */
    .yellow-checkbox span {
      border-color: #facc15;
    }

    .yellow-checkbox input[type="checkbox"]:checked+span {
      background: #facc15;
      border-color: #facc15;
    }

    /* Red Card */
    .red-checkbox span {
      border-color: #ef4444;
    }

    .red-checkbox input[type="checkbox"]:checked+span {
      background: #ef4444;
      border-color: #ef4444;
    }

  @media (max-width: 1023px) {
      .form-and-list-grid {
        grid-template-columns: repeat(1, minmax(0, 1fr));
        /* Stack form and list on medium screens */
      }
    }

    @media (max-width: 640px) {

      /* Team scoring cards and match summary card full width and less padding */
      .card-hover.glassmorphism {
        width: 100% !important;
        min-width: 0 !important;
        padding: 1rem !important;
        margin-bottom: 1rem;
      }

      .player-events-table {
        overflow-x: auto;
        width: 100%;
      }

      .player-events-table table {
        min-width: 400px;
      }

      .match-summary-card {
        width: 100% !important;
        min-width: 0 !important;
        padding: 1rem !important;
        margin-bottom: 1rem;
      }

      .match-summary-card form {
        gap: 0.5rem !important;
      }

      .team-scoring-card {
        width: 100% !important;
        min-width: 0 !important;
        padding: 1rem !important;
        margin-bottom: 1rem;
        display: block !important;
      }

      .team-scoring-card h3 {
        font-size: 1.1rem !important;
        flex-wrap: wrap !important;
      }

      .team-scoring-card form {
        flex-direction: column !important;
        gap: 0.5rem !important;
        width: 100%;
      }

      .team-scoring-card button {
        width: 100%;
        margin-bottom: 0.25rem;
      }
    }

    /* New styles for hiding/showing content */
    .hidden {
      display: none;
    }

    /* Styles for the match details view */
    #matchDetailsView {
      grid-column: 1 / -1;
      /* Span across all columns in the main grid */
      /* Add any specific styling for this new section */
    }

    /* Adjusting the layout for the match details view on larger screens */
  @media (min-width: 1024px) {
      #matchesContent>div:first-child {
        /* Match Stats */
        grid-template-columns: repeat(1, minmax(0, 1fr)) repeat(2,
            minmax(0, 1fr));
      }

      #matchesContent>div:nth-child(2):not(.hidden) {
        /* Forms and List */
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 2rem;
      }

      #matchesContent>div:nth-child(2)>div:first-child {
        /* Create Match Card */
        grid-column: 1 / 2;
      }

      #matchesContent>div:nth-child(2)>div:nth-child(2) {
        /* Matches List */
        grid-column: 2 / 3;
      }

      /* CORRECTED: This now stacks all cards vertically, each on its own row. */
      #matchDetailsView:not(.hidden) {
        display: flex;
        flex-direction: column;
        /* Stacks children vertically */
        gap: 2rem;
        /* Provides space between the stacked cards */
      }
    }
	  
	  @media only screen and (max-width: 768px) {
		  .fl-module-content,
		  .fl-module:where(.fl-module:not(:has(> .fl-module-content))) {
			margin: 5px !important;
		  }
		}


    @media (min-width: 769px) and (max-width: 1023px) {
      #matchesContent>div:nth-child(2) {
        /* Forms and List */
        grid-template-columns: repeat(1, minmax(0, 1fr));
        /* Stack on medium screens */
      }

      #matchDetailsView {
        grid-template-columns: repeat(1, minmax(0, 1fr));
        /* Stack on medium screens */
      }
    }

    .player-events-table {
      overflow-x: auto;
    }

    /* Match Report Popup Styles */
    #matchReportPopup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    #matchReportPopup.show {
      display: flex;
    }

    .match-report-modal {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .match-report-header {
      padding: 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .match-report-header h2 {
      color: white;
      font-size: 24px;
      font-weight: 600;
      margin: 0;
    }

    .match-report-close {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .match-report-close:hover {
      color: white;
      background: rgba(255, 255, 255, 0.1);
    }

    .match-report-content {
      padding: 24px;
      color: white;
    }

    .match-report-section {
      margin-bottom: 24px;
    }

    .match-report-section h3 {
      color: #6366f1;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
    }

    .match-report-section h3 i {
      margin-right: 8px;
    }

    .match-report-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    .match-report-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 16px;
    }

    .match-report-item-label {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      margin-bottom: 4px;
    }

    .match-report-item-value {
      color: white;
      font-size: 16px;
      font-weight: 500;
    }

    .match-report-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
    }

    .match-report-stat {
      text-align: center;
      padding: 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }

    .match-report-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #10b981;
      margin-bottom: 4px;
    }

    .match-report-stat-label {
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    @media (max-width: 640px) {
      .match-report-modal {
        width: 95%;
        margin: 20px;
      }

      .match-report-header {
        padding: 16px;
      }

      .match-report-content {
        padding: 16px;
      }

      .match-report-grid {
        grid-template-columns: 1fr;
      }

      .match-report-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen">
  <!-- Animated Background Elements -->
  <div class="fixed inset-0 overflow-hidden pointer-events-none">
    <div
      class="absolute -top-40 -right-40 w-80 h-80 bg-purple-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-float">
    </div>
    <div
      class="absolute -bottom-40 -left-40 w-80 h-80 bg-blue-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-float"
      style="animation-delay: 2s"></div>
    <div
      class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-80 h-80 bg-pink-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-float"
      style="animation-delay: 4s"></div>
  </div>

  <div class="flex">
    <!-- Sidebar -->
  <div id="sidebar" class="sidebar min-h-screen w-64 glassmorphism border-r border-white/10 flex-shrink-0 overflow-y-auto">
      <div class="p-6">
        <div class="mb-8 flex flex-col items-center">
          <a href="https://soccer6league.com" target="_blank" rel="noopener noreferrer" class="flex items-center w-20 h-20 mb-4 transition-transform hover:scale-105">
            <img src="https://soccer6league.com/wp-content/uploads/2024/10/soccer-6-wgreen-300x237.png"
              alt="Soccer6 League" class="w-full h-full object-contain drop-shadow-lg" />
          </a>    
        </div>

        <nav class="space-y-1">
          <!-- Active Tab -->
          <a href="#" id="teamsTab" data-tab="teams"
            class="sidebar-item flex items-center space-x-3 px-4 py-3 text-white bg-white/10 rounded-lg">
            <i class="fas fa-users w-5 h-5"></i>
            <span class="font-medium">Teams</span>
          </a>
          <!-- Changed "Projects" to "Matches" -->
          <a href="#" id="matchesTab" data-tab="matches"
            class="sidebar-item flex items-center space-x-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-white/5 rounded-lg">
            <i class="fas fa-calendar-alt w-5 h-5"></i>
            <span>Matches</span>
          </a>
          <!-- New Completed Matches Tab -->
          <a href="#" id="completedMatchesTab" data-tab="completedMatches"
            class="sidebar-item flex items-center space-x-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-white/5 rounded-lg">
            <i class="fas fa-check-circle w-5 h-5"></i>
            <span>Completed Matches</span>
          </a>
          <!-- New Referees Tab -->
          <a href="#" id="refereesTab" data-tab="referees"
            class="sidebar-item flex items-center space-x-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-white/5 rounded-lg">
            <i class="fas fa-user mr-3 text-white"></i>
            <span>Referees</span>
          </a>
          <!-- New Players Tab -->
          <a href="#" id="playersTab" data-tab="players"
            class="sidebar-item flex items-center space-x-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-white/5 rounded-lg">
            <i class="fas fa-user-friends w-5 h-5"></i>
            <span>Players</span>
          </a>
        </nav>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content flex-1 overflow-y-auto">
      <!-- Header -->
      <header class="header glassmorphism border-b border-white/10 p-6 flex items-center justify-between">
        <div>
          <h2 id="pageTitle" class="text-2xl font-bold text-white">
            Team Management
          </h2>
          <p id="pageDescription" class="text-gray-400">
            Create and manage your teams efficiently
          </p>
        </div>
        <!-- Hamburger Icon for Mobile -->
        <button id="mobileMenuButton"
          class="mobile-menu-icon p-2 rounded-md text-gray-400 hover:text-white focus:outline-none focus:ring-2 focus:ring-white">
          <i class="fas fa-bars w-6 h-6"></i>
        </button>
      </header>

      <!-- Dashboard Content -->
       <!-- for tab pe-0  -->
      <div class="pe-4 md:pe-0 lg:p-4">
        <!-- Teams Content Section -->
        <div id="teamsContent" class="space-y-8">
          <!-- Stats Cards -->
          <div class="stats-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <div class="card-hover glassmorphism rounded-2xl p-6 border border-white/10">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm">Total Teams</p>
                  <p class="text-3xl font-bold text-white" id="totalTeams">
                    0
                  </p>
                </div>
                <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center">
                  <i class="fas fa-users text-blue-400 text-xl"></i>
                </div>
              </div>
            </div>
            <!-- Matches Played stat card -->
            <div class="card-hover glassmorphism rounded-2xl p-6 border border-white/10">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm">Matches Played</p>
                  <p class="text-3xl font-bold text-white" id="matchesPlayed">
                    0
                  </p>
                </div>
                <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center">
                  <i class="fas fa-check-circle text-green-400 text-2xl"></i>
                </div>
              </div>
            </div>
            <div class="card-hover glassmorphism rounded-2xl p-6 border border-white/10">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm">Team Members</p>
                  <p class="text-3xl font-bold text-white" id="totalMembers">
                    0
                  </p>
                </div>
                <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center">
                  <i class="fas fa-users text-purple-400 text-2xl"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- Create Team Form and Teams List -->
          <div class="form-and-list-grid grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="card-hover glassmorphism rounded-2xl p-8 border border-white/10">
              <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                <i class="fas fa-plus mr-3 text-purple-400"></i>
                Create New Team
              </h3>
              <form id="createTeamForm" class="space-y-6">
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">Team Name</label>
                  <input type="text" id="teamName" required
                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                    placeholder="Enter team name" />
                </div>
                <!-- Team Classification Fields -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Location</label>
                    <input type="text" id="teamLocation"
                      class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                      placeholder="e.g. East" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Day</label>
                    <select id="teamDay"
                      class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                      <option value="">Select Day</option>
                      <option value="Monday">Monday</option>
                      <option value="Tuesday">Tuesday</option>
                      <option value="Wednesday">Wednesday</option>
                      <option value="Thursday">Thursday</option>
                      <option value="Friday">Friday</option>
                      <option value="Saturday">Saturday</option>
                      <option value="Sunday">Sunday</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">League</label>
                    <input type="text" id="teamLeague"
                      class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                      placeholder="e.g. Premier" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Division</label>
                    <input type="text" id="teamDivision"
                      class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                      placeholder="e.g. A" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Season</label>
                    <input type="text" id="teamSeason"
                      class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                      placeholder="e.g. Spring" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Year</label>
                    <input type="number" id="teamYear"
                      class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                      placeholder="e.g. 2025" />
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">Team Jersey Image</label>
                  <input type="file" id="teamJerseyImage" name="team_jersey_image" required accept="image/*"
                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700 cursor-pointer" />
                  <div id="jerseyImagePreviewContainer" class="mt-4 hidden">
                    <img id="jerseyImagePreview" src="#" alt="Jersey Preview"
                      class="max-h-40 rounded-lg border-2 border-white/20" />
                  </div>
                </div>
                <!-- Add Members Section -->
                <div id="addMembersSection" class="space-y-4 border-t border-white/20 pt-4 mt-4">
                  <h4 class="text-lg font-semibold text-white mb-4">
                    Add Members
                  </h4>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">Player ID</label>
                      <input type="number" id="playerId"
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                        placeholder="Enter player ID" />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">Player Name</label>
                      <input type="text" id="playerName"
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                        placeholder="Enter player name" />
                    </div>
                  </div>
                  <div class="flex justify-end">
                    <button type="button" id="addMemberButton"
                      class="px-4 py-2 bg-gradient-to-br from-purple-600 to-pink-600 text-white rounded-lg font-medium hover:from-purple-700 hover:to-pink-700 transition-all">
                      Add Member
                    </button>
                  </div>
                  <div id="addedMembersList" class="space-y-3 max-h-48 overflow-y-auto">
                    <!-- Added members will appear here -->
                  </div>
                </div>

                <button type="submit"
                  class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 px-6 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-200 shadow-lg">
                  Create Team
                </button>
              </form>
            </div>

            <!-- Teams List -->
            <div class="card-hover glassmorphism rounded-2xl p-8 border border-white/10">
              <h3 class="text-2xl font-bold text-white mb-6 flex items-center justify-between">
                <span class="flex items-center">
                  <i class="fas fa-users mr-3 text-blue-400"></i>
                  Teams
                </span>
                <button id="teamsFilterToggle" type="button"
                  class="text-purple-400 hover:text-purple-300 transition-colors">
                  <i class="fas fa-filter"></i>
                </button>
              </h3>
              <!-- Teams Filters Panel -->
              <div id="teamsFilters" class="hidden mb-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
                <select id="filterLocation" class="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                  <option value="">All Locations</option>
                </select>
                <select id="filterDay" class="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                  <option value="">All Days</option>
                </select>
                <select id="filterLeague" class="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                  <option value="">All Leagues</option>
                </select>
                <select id="filterDivision" class="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                  <option value="">All Divisions</option>
                </select>
                <select id="filterSeason" class="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                  <option value="">All Seasons</option>
                </select>
                <select id="filterYear" class="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                  <option value="">All Years</option>
                </select>
              </div>
              <div id="teamsList" class="space-y-4 overflow-y-auto h-[800px]">
                <!-- Teams will be loaded here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Matches Content Section -->
        <div id="matchesContent" class="space-y-8">
          <!-- Match Stats Cards -->
          <div class="stats-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <div class="card-hover glassmorphism rounded-2xl p-6 border border-white/10">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm">Total Matches</p>
                  <p class="text-3xl font-bold text-white" id="totalMatches">
                    0
                  </p>
                </div>
                <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center">
                  <i class="fas fa-chart-bar text-blue-400 text-2xl"></i>
                </div>
              </div>
            </div>

            <div class="card-hover glassmorphism rounded-2xl p-6 border border-white/10">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm">Upcoming Matches</p>
                  <p class="text-3xl font-bold text-white" id="upcomingMatches">
                    0
                  </p>
                </div>
                <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center">
                  <i class="fas fa-clock text-orange-400 text-2xl"></i>
                </div>
              </div>
            </div>

            <div class="card-hover glassmorphism rounded-2xl p-6 border border-white/10">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm">Completed Matches</p>
                  <p class="text-3xl font-bold text-white" id="completedMatches">
                    0
                  </p>
                </div>
                <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center">
                  <i class="fas fa-check-circle text-green-400 text-2xl"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- Form for Creating/Editing Matches -->
          <div id="matchesFormGrid" class="grid gap-8 grid-cols-1">
            <!-- This section will hold the match creation form OR the match details view -->
            <div id="createMatchCard" class="card-hover glassmorphism rounded-2xl p-8 border border-white/10">
              <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                <i class="fas fa-plus mr-3 text-purple-400"></i>
                <span id="matchFormTitle">Create New Match</span>
              </h3>
              <form id="createMatchForm" class="space-y-6">
                <!-- Matches Filters Toggle -->
                <div class="flex justify-end">
                  <button id="matchesFilterToggle" type="button"
                    class="text-purple-400 hover:text-purple-300 transition-colors">
                    <i class="fas fa-filter"></i>
                  </button>
                </div>
                <!-- Matches Filters Panel -->
                <div id="matchesFilters" class="hidden grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <select id="mFilterLocation"
                    class="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                    <option value="">All Locations</option>
                  </select>
                  <select id="mFilterDay" class="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                    <option value="">All Days</option>
                  </select>
                  <select id="mFilterLeague" class="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                    <option value="">All Leagues</option>
                  </select>
                  <select id="mFilterDivision"
                    class="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                    <option value="">All Divisions</option>
                  </select>
                  <select id="mFilterSeason" class="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                    <option value="">All Seasons</option>
                  </select>
                  <select id="mFilterYear" class="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                    <option value="">All Years</option>
                  </select>
                </div>
                <!-- Team 1 Selection -->
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2" for="team1Select">Team 1</label>
                  <select id="team1Select" required
                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                    <option value="" disabled selected hidden>
                      Select Team 1
                    </option>
                    <!-- Team options will be populated by JavaScript -->
                  </select>
                </div>

                <!-- Team 2 Selection -->
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2" for="team2Select">Team 2</label>
                  <select id="team2Select" required
                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                    <option value="" disabled selected hidden>
                      Select Team 2
                    </option>
                    <!-- Team options will be populated by JavaScript -->
                  </select>
                </div>

                <!-- Date Input -->
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2" for="matchDate">Date</label>
                  <input type="date" id="matchDate" required
                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" />
                </div>

                <!-- Location Input -->
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2" for="matchLocation">Location</label>
                  <input type="text" id="matchLocation"
                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                    placeholder="Enter match location" />
                </div>

                <!-- Week Input -->
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2" for="matchWeek">Week</label>
                  <input type="number" id="matchWeek"
                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                    placeholder="Enter week number" min="1" />
                </div>

                <!-- Referee Input -->
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2" for="matchReferee">Referee</label>
                  <select id="matchReferee" required
                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                    <option value="" disabled selected hidden>
                      Select Referee
                    </option>
                    <!-- Referee options will be populated by JavaScript -->
                  </select>
                </div>

                <button type="submit"
                  class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 px-6 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-200 shadow-lg">
                  Create Match
                </button>
              </form>
            </div>

            <!-- Matches List -->
            <div class="card-hover glassmorphism rounded-2xl p-8 border border-white/10">
              <h3 class="text-2xl font-bold text-white mb-6 flex items-center justify-between">
                <span class="flex items-center">
                  <i class="fas fa-envelope mr-3 text-red-400"></i>
                  Matches
                </span>
                <!-- Refresh button (consider adding functionality if needed) -->
                <button class="text-purple-400 hover:text-purple-300 transition-colors"
                  onclick="fetchAndRenderMatches()">
                  <i class="fas fa-sync"></i>
                </button>
              </h3>
              <div id="matchesList" class="space-y-4 max-h-[600px] overflow-y-auto">
                <!-- Matches will be loaded here -->
                <div class="text-center py-12 text-gray-400">
                  <i class="fas fa-inbox w-16 h-16 mx-auto mb-4 opacity-50 text-6xl"></i>
                  <p class="text-lg">No matches scheduled yet</p>
                  <p class="text-sm">
                    Create your first match to get started
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- New Section for Match Details/Start Match -->
          <div id="matchDetailsView" class="space-y-8 hidden">
            <!-- This section will be populated when a match is started -->
          </div>
        </div>

        <!-- Completed Matches Content Section -->
        <div id="completedMatchesContent" class="space-y-8 hidden">
          <!-- Completed Matches Stats Cards -->
          <div class="stats-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <div class="card-hover glassmorphism rounded-2xl p-6 border border-white/10">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm">Total Completed Matches</p>
                  <p class="text-3xl font-bold text-white" id="totalCompletedMatches">
                    0
                  </p>
                </div>
                <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center">
                  <i class="fas fa-check-circle text-green-400 text-xl"></i>
                </div>
              </div>
            </div>

            <div class="card-hover glassmorphism rounded-2xl p-6 border border-white/10">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm">Total Goals Scored</p>
                  <p class="text-3xl font-bold text-white" id="totalGoalsScored">
                    0
                  </p>
                </div>
                <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center">
                  <i class="fas fa-futbol text-blue-400 text-xl"></i>
                </div>
              </div>
            </div>

            <div class="card-hover glassmorphism rounded-2xl p-6 border border-white/10">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm">Total Cards Issued</p>
                  <p class="text-3xl font-bold text-white" id="totalCardsIssued">
                    0
                  </p>
                </div>
                <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center">
                  <i class="fas fa-exclamation-triangle text-yellow-400 text-xl"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- Completed Matches Filters -->
          <div class="card-hover glassmorphism rounded-2xl p-8 border border-white/10">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-2xl font-bold text-white flex items-center">
                <i class="fas fa-filter mr-3 text-purple-400"></i>
                Filters
              </h3>
              <button id="completedMatchesFilterToggle" type="button"
                class="text-purple-400 hover:text-purple-300 transition-colors">
                <i class="fas fa-chevron-down"></i>
              </button>
            </div>

            <!-- Completed Matches Filters Panel -->
            <div id="completedMatchesFilters" class="hidden mb-6">
              <div class="glassmorphism rounded-2xl p-4 border border-white/10">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 items-center">
                  <div class="lg:col-span-2">
                    <label class="text-xs text-gray-300 block mb-1">Search Teams</label>
                    <input type="text" id="filterCompletedMatchSearch" placeholder="Search by team name..." class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500">
                  </div>

                  <div>
                    <label class="text-xs text-gray-300 block mb-1">From Date</label>
                    <input type="date" id="filterCompletedMatchDateFrom" class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                  </div>

                  <div>
                    <label class="text-xs text-gray-300 block mb-1">To Date</label>
                    <input type="date" id="filterCompletedMatchDateTo" class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                  </div>
                </div>

                <div class="mt-4 flex justify-end">
                  <button id="clearCompletedMatchFilters" class="px-4 py-2 bg-green-700/30 text-white rounded-lg hover:bg-green-700 transition">Clear Filters</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Completed Matches List -->
          <div class="card-hover glassmorphism rounded-2xl p-8 border border-white/10">
            <div id="completedMatchesList" class="space-y-4 max-h-[800px] overflow-y-auto">
              <!-- Completed matches will be loaded here -->
              <div class="text-center py-12 text-gray-400">
                <i class="fas fa-inbox w-16 h-16 mx-auto mb-4 opacity-50 text-6xl"></i>
                <p class="text-lg">No completed matches yet</p>
                <p class="text-sm">
                  Completed matches will appear here once referees finish reporting
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Referees Content Section -->
        <div id="refereesContent" class="space-y-8 hidden">
          <!-- Referee Stats Cards -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card-hover glassmorphism rounded-2xl p-6 border border-white/10">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm">Total Referees</p>
                  <p class="text-3xl font-bold text-white" id="totalReferees">0</p>
                </div>
                <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center">
                  <i class="fas fa-user text-indigo-400 text-2xl"></i>
                </div>
              </div>
            </div>
            <div class="card-hover glassmorphism rounded-2xl p-6 border border-white/10">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm">Matches Assigned</p>
                  <p class="text-3xl font-bold text-white" id="refMatchesAssigned">0</p>
                </div>
                <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center">
                  <i class="fas fa-envelope text-blue-400 text-2xl"></i>
                </div>
              </div>
            </div>
            <div class="card-hover glassmorphism rounded-2xl p-6 border border-white/10">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm">Upcoming</p>
                  <p class="text-3xl font-bold text-white" id="refUpcoming">0</p>
                </div>
                <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center">
                  <i class="fas fa-clock text-orange-400 text-2xl"></i>
                </div>
              </div>
            </div>
            <div class="card-hover glassmorphism rounded-2xl p-6 border border-white/10">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm">Completed</p>
                  <p class="text-3xl font-bold text-white" id="refCompleted">0</p>
                </div>
                <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center">
                  <i class="fas fa-check text-green-400 text-2xl"></i>
                </div>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Create/Edit Referee Form -->
            <div class="card-hover glassmorphism rounded-2xl p-8 border border-white/10">
              <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                <i class="fas fa-plus mr-3 text-purple-400"></i>
                <span id="refFormTitle">Create Referee</span>
              </h3>
              <form id="refereeForm" class="space-y-4">
                <input type="hidden" id="refUserId" />
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">First Name</label>
                    <input id="refFirstName" type="text"
                      class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                      placeholder="John" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Last Name</label>
                    <input id="refLastName" type="text"
                      class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                      placeholder="Doe" />
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                  <input id="refEmail" type="email"
                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    placeholder="john@example.com" required />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">Username (optional)</label>
                  <input id="refUsername" type="text"
                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    placeholder="john.doe" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">Password (set to change)</label>
                  <input id="refPassword" type="password"
                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    placeholder="" />
                </div>
                <div class="flex gap-3">
                  <button type="submit" id="refSubmitBtn"
                    class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600">Save</button>
                  <button type="button" id="refCancelEditBtn"
                    class="px-4 py-2 bg-white/10 border border-white/20 text-white rounded-lg hidden">Cancel</button>
                </div>
              </form>
            </div>

            <!-- Referees List -->
            <div class="card-hover glassmorphism rounded-2xl p-8 border border-white/10">
              <h3 class="text-2xl font-bold text-white mb-6 flex items-center justify-between">
                <span class="flex items-center">
                  <i class="fas fa-user mr-3 text-blue-400"></i>
                  Referees
                </span>
                <button id="refreshRefereesBtn" class="text-purple-400 hover:text-purple-300 transition-colors">
                  <i class="fas fa-sync"></i>
                </button>
              </h3>
              <div id="refereesList" class="space-y-3 max-h-[500px] overflow-y-auto">
                <div class="text-center py-8 text-gray-400">No referees yet.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Players Content Section -->
        <div id="playersContent" class="space-y-8 hidden">
          <!-- Player Stats Cards -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card-hover glassmorphism rounded-2xl p-6 border border-white/10">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm">Total Players</p>
                  <p class="text-3xl font-bold text-white" id="totalPlayers">0</p>
                </div>
                <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center">
                  <i class="fas fa-user text-purple-400 text-2xl"></i>
                </div>
              </div>
            </div>
            <div class="card-hover glassmorphism rounded-2xl p-6 border border-white/10">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm">Total Goals</p>
                  <p class="text-3xl font-bold text-white" id="totalGoals">0</p>
                </div>
                <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center">
                  <i class="fas fa-check text-green-400 text-2xl"></i>
                </div>
              </div>
            </div>
            <div class="card-hover glassmorphism rounded-2xl p-6 border border-white/10">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm">Total Cards</p>
                  <p class="text-3xl font-bold text-white" id="totalCards">0</p>
                </div>
                <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center">
                  <i class="fas fa-exclamation-triangle text-yellow-400 text-2xl"></i>
                </div>
              </div>
            </div>
            <div class="card-hover glassmorphism rounded-2xl p-6 border border-white/10">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm">Active Players</p>
                  <p class="text-3xl font-bold text-white" id="activePlayers">0</p>
                </div>
                <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center">
                  <i class="fas fa-check-circle text-blue-400 text-2xl"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- Players List with Filters -->
          <div class="card-hover glassmorphism rounded-2xl p-8 border border-white/10">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-2xl font-bold text-white flex items-center">
                <i class="fas fa-user mr-3 text-purple-400"></i>
                Players Statistics
              </h3>
              <button id="playersFilterToggle" type="button"
                class="text-purple-400 hover:text-purple-300 transition-colors">
                <i class="fas fa-filter"></i>
              </button>
            </div>

            <!-- Players Filters Panel -->
            <div id="playersFilters" class="hidden mb-6">
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                <select id="filterPlayerSeason"
                  class="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                  <option value="">All Seasons</option>
                </select>
                <select id="filterPlayerTeam"
                  class="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                  <option value="">All Teams</option>
                </select>
                <input type="text" id="filterPlayerName" placeholder="Search by name..."
                  class="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
            </div>

            <!-- Players Table -->
            <div class="overflow-x-auto">
              <table class="w-full text-white">
                <thead>
                  <tr class="border-b border-white/20">
                    <th class="text-left py-3 px-4 font-medium text-gray-300">Player Name</th>
                    <th class="text-center py-3 px-4 font-medium text-gray-300">Team</th>
                    <th class="text-center py-3 px-4 font-medium text-gray-300">Games Played</th>
                    <th class="text-center py-3 px-4 font-medium text-gray-300">Injuries</th>
                    <th class="text-center py-3 px-4 font-medium text-gray-300">Blue Cards</th>
                    <th class="text-center py-3 px-4 font-medium text-gray-300">Yellow Cards</th>
                    <th class="text-center py-3 px-4 font-medium text-gray-300">Red Cards</th>
                    <th class="text-center py-3 px-4 font-medium text-gray-300">Goals</th>
                  </tr>
                </thead>
                <tbody id="playersTableBody">
                  <tr>
                    <td colspan="8" class="text-center py-12 text-gray-400">
                      <i class="fas fa-user w-16 h-16 mx-auto mb-4 opacity-50 text-6xl"></i>
                      <p class="text-lg">Loading player statistics...</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Team management state
    let teams = [];
    let teamIdCounter = 1;

    // Temporary storage for members being added to a team before creation
    let currentTeamMembers = [];

    // Variable to keep track of the index of the member being edited
    let editingMemberIndex = -1;

    // Variable to store the ID of the team being edited, if any
    let editingTeamId = null;

    // Match state
    let matches = [];
    let matchIdCounter = 1;
    let editingMatchId = null; // Track match being edited

    // DOM Elements
    const sidebar = document.getElementById("sidebar");
    const mobileMenuButton = document.getElementById("mobileMenuButton");
    const sidebarLinks = document.querySelectorAll(".sidebar-item");
    const teamsContent = document.getElementById("teamsContent");
    const matchesContent = document.getElementById("matchesContent");
    const completedMatchesContent = document.getElementById("completedMatchesContent");
    const pageTitle = document.getElementById("pageTitle");
    const pageDescription = document.getElementById("pageDescription");
    // Referees DOM
    const refereesContent = document.getElementById("refereesContent");
    const refereesList = document.getElementById("refereesList");
    const refForm = document.getElementById("refereeForm");
    const refFormTitle = document.getElementById("refFormTitle");
    const refUserId = document.getElementById("refUserId");
    const refFirstName = document.getElementById("refFirstName");
    const refLastName = document.getElementById("refLastName");
    const refEmail = document.getElementById("refEmail");
    const refUsername = document.getElementById("refUsername");
    const refPassword = document.getElementById("refPassword");
    const refCancelEditBtn = document.getElementById("refCancelEditBtn");
    const refreshRefereesBtn = document.getElementById("refreshRefereesBtn");
    // Referee stats
    const totalRefereesEl = document.getElementById("totalReferees");
    const refMatchesAssignedEl = document.getElementById("refMatchesAssigned");
    const refUpcomingEl = document.getElementById("refUpcoming");
    const refCompletedEl = document.getElementById("refCompleted");

    // Players DOM
    const playersContent = document.getElementById("playersContent");
    const playersTableBody = document.getElementById("playersTableBody");
    const playersFilterToggle = document.getElementById("playersFilterToggle");
    const playersFilters = document.getElementById("playersFilters");
    // Player stats
    const totalPlayersEl = document.getElementById("totalPlayers");
    const totalGoalsEl = document.getElementById("totalGoals");
    const totalCardsEl = document.getElementById("totalCards");
    const activePlayersEl = document.getElementById("activePlayers");
    // Player filters
    const filterPlayerTeam = document.getElementById("filterPlayerTeam");
    const filterPlayerSeason = document.getElementById("filterPlayerSeason");
    const filterPlayerName = document.getElementById("filterPlayerName");

    // Form and Member Input Elements (Teams)
    const createTeamForm = document.getElementById("createTeamForm");
    const teamNameInput = document.getElementById("teamName");
    // Team classification inputs
    const teamLocationInput = document.getElementById("teamLocation");
    const teamDayInput = document.getElementById("teamDay");
    const teamLeagueInput = document.getElementById("teamLeague");
    const teamDivisionInput = document.getElementById("teamDivision");
    const teamSeasonInput = document.getElementById("teamSeason");
    const teamYearInput = document.getElementById("teamYear");
    const addMembersSection = document.getElementById("addMembersSection");
    const playerIdInput = document.getElementById("playerId");
    const playerNameInput = document.getElementById("playerName");
    const addMemberButton = document.getElementById("addMemberButton");
    const addedMembersList = document.getElementById("addedMembersList");
    const createTeamButton = createTeamForm.querySelector(
      'button[type="submit"]'
    ); // Get the create team button

    // Form Elements (Matches)
    const createMatchForm = document.getElementById("createMatchForm");
    const team1Select = document.getElementById("team1Select");
    const team2Select = document.getElementById("team2Select");
    const matchDateInput = document.getElementById("matchDate");
    const matchLocationInput = document.getElementById("matchLocation");
    const matchWeekInput = document.getElementById("matchWeek");
    const matchRefereeInput = document.getElementById("matchReferee");
    const matchesListContainer = document.getElementById("matchesList");
    const matchFormTitle = document.getElementById("matchFormTitle");
    const matchSubmitButton = createMatchForm.querySelector(
      'button[type="submit"]'
    );

    const teamJerseyImageInput = document.getElementById("teamJerseyImage");
    const jerseyImagePreview = document.getElementById("jerseyImagePreview");
    const jerseyImagePreviewContainer = document.getElementById(
      "jerseyImagePreviewContainer"
    );

    // New DOM Elements for the match details view
    const matchesFormGrid = document.getElementById("matchesFormGrid");
    const createMatchCard = document.getElementById("createMatchCard");
    const matchDetailsView = document.getElementById("matchDetailsView");

    // Function to show a specific tab's content
    function showTab(tabName) {
      // Hide all content sections
      teamsContent.classList.add("hidden");
      matchesContent.classList.add("hidden");
      completedMatchesContent.classList.add("hidden");
      refereesContent.classList.add("hidden");
      playersContent.classList.add("hidden");

      // Remove active class from all sidebar links
      sidebarLinks.forEach((link) => {
        link.classList.remove("active", "bg-white/10", "text-white");
        link.classList.add("text-gray-300", "hover:bg-white/5");
      });

      // Show the selected tab's content and mark the link as active
      if (tabName === "teams") {
        teamsContent.classList.remove("hidden");
        document
          .getElementById("teamsTab")
          .classList.add("active");
        pageTitle.textContent = "Team Management";
        pageDescription.textContent =
          "Create and manage your teams efficiently";
      } else if (tabName === "matches") {
        matchesContent.classList.remove("hidden");
        document
          .getElementById("matchesTab")
          .classList.add("active");
        pageTitle.textContent = "Match Management";
        pageDescription.textContent = "View and manage upcoming matches";
        // Populate team select dropdowns when the matches tab is shown
        populateTeamSelects();
        // Refresh referee list for match form
        if (typeof populateRefereeSelect === 'function') { try { populateRefereeSelect(); } catch (e) { } }
        // Re-apply match filters to dropdowns
        applyMatchTeamFilters();
        // Ensure create match form is visible when matches tab is selected
        matchesFormGrid.classList.remove("hidden");
        matchDetailsView.classList.add("hidden");
      } else if (tabName === "completedMatches") {
        completedMatchesContent.classList.remove("hidden");
        document.getElementById("completedMatchesTab").classList.add("active");
        pageTitle.textContent = "Completed Matches";
        pageDescription.textContent = "View and analyze completed match reports";
        fetchCompletedMatches();
        // Auto-expand filters for completed matches (match referee dashboard behavior)
        const cmFilters = document.getElementById('completedMatchesFilters');
        const cmToggle = document.getElementById('completedMatchesFilterToggle');
        if (cmFilters && cmFilters.classList.contains('hidden')) cmFilters.classList.remove('hidden');
        if (cmToggle) {
          const icon = cmToggle.querySelector('i');
          if (icon) { icon.classList.remove('fa-chevron-down'); icon.classList.add('fa-chevron-up'); }
        }
      } else if (tabName === "referees") {
        refereesContent.classList.remove("hidden");
        document.getElementById("refereesTab").classList.add("active");
        pageTitle.textContent = "Referee Management";
        pageDescription.textContent = "Create, edit, and manage referees";
        fetchRefereeStats();
        fetchRefereesFull();
      } else if (tabName === "players") {
        playersContent.classList.remove("hidden");
        document.getElementById("playersTab").classList.add("active");
        pageTitle.textContent = "Players Statistics";
        pageDescription.textContent = "View and analyze player performance data";
        fetchPlayersData();
        populatePlayersFilterOptions();
      }

  // Close sidebar on mobile/tablet after clicking a tab
  if (window.innerWidth <= 1023) {
        sidebar.classList.remove("active");
        const overlay = document.getElementById("sidebarOverlay");
        if (overlay) overlay.classList.remove("active");
        // Restore body scroll when sidebar is closed via tab selection
        document.body.classList.remove('no-scroll');
      }
    }

    // Event listener for sidebar links
    sidebarLinks.forEach((link) => {
      link.addEventListener("click", function (e) {
        e.preventDefault();
        const tabName = this.getAttribute("data-tab");
        showTab(tabName);
      });
    });

    // Event listener for the mobile menu button
    mobileMenuButton.addEventListener("click", () => {
      const isActive = sidebar.classList.toggle("active");
      let overlay = document.getElementById("sidebarOverlay");
      if (!overlay) {
        overlay = document.createElement("div");
        overlay.id = "sidebarOverlay";
        overlay.className = 'sidebar-overlay';
        document.body.appendChild(overlay);
      }
      overlay.classList.toggle("active", isActive);
      // Toggle body scrolling
      document.body.classList.toggle('no-scroll', isActive);
    });

    // Close sidebar and overlay when clicking outside of it
    document.addEventListener("click", (e) => {
      const overlay = document.getElementById("sidebarOverlay");
      if (
        sidebar.classList.contains("active") &&
        !sidebar.contains(e.target) &&
        !mobileMenuButton.contains(e.target)
      ) {
        sidebar.classList.remove("active");
        if (overlay) overlay.classList.remove("active");
        // Ensure body scroll is restored
        document.body.classList.remove('no-scroll');
      }
    });

    // Initial tab display (default to teams)
    showTab("teams");

    // --- Completed Matches Management Logic ---
    let completedMatchesData = [];

    function fetchCompletedMatches() {
      jQuery.ajax({
        url: your_plugin_ajax_object.ajax_url,
        type: 'POST',
        data: {
          action: 'your_plugin_fetch_completed_matches',
          nonce: your_plugin_ajax_object.nonce
        },
        success: function (response) {
          if (response.success) {
            completedMatchesData = response.data.matches || [];
            updateCompletedMatchesStats(response.data.stats || {});
            renderCompletedMatches();
          } else {
            showNotification('Failed to load completed matches.', 'error');
          }
        },
        error: function () {
          showNotification('Failed to load completed matches.', 'error');
        }
      });
    }

    function updateCompletedMatchesStats(stats) {
      document.getElementById("totalCompletedMatches").textContent = stats.total_completed_matches || 0;
      document.getElementById("totalGoalsScored").textContent = stats.total_goals || 0;
      document.getElementById("totalCardsIssued").textContent = stats.total_cards || 0;
    }

    function renderCompletedMatches() {
      const container = document.getElementById("completedMatchesList");
      if (!completedMatchesData || completedMatchesData.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12 text-gray-400">
                <i class="fas fa-inbox w-16 h-16 mx-auto mb-4 opacity-50 text-6xl"></i>
                <p class="text-lg">No completed matches yet</p>
                <p class="text-sm">Completed matches will appear here once referees finish reporting</p>
            </div>
        `;
        return;
      }

      // Apply filters
      const filteredMatches = applyCompletedMatchesFilters();

      if (filteredMatches.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-400">
                <p>No matches match the current filters</p>
            </div>
        `;
        return;
      }

      // Render as a single-row list item (jerseys left, info center, action right)
      container.innerHTML = filteredMatches
        .map((match) => {
          const team1Name = getTeamNameById(match.team1Id);
          const team2Name = getTeamNameById(match.team2Id);
          const team1Jersey = getTeamJerseyById(match.team1Id);
          const team2Jersey = getTeamJerseyById(match.team2Id);
          return `
            <div class="bg-white/5 border border-white/10 rounded-xl p-4 hover:bg-white/10 transition-all duration-300 group relative">
              <div class="flex items-center gap-4">
                <!-- Jerseys (left) -->
                <div class="flex items-center gap-3 w-48">
                  <img src="${team1Jersey}" alt="${team1Name} Jersey" class="w-12 h-12 rounded-full object-cover border-2 border-white/20">
                  <span class="text-white font-semibold">vs</span>
                  <img src="${team2Jersey}" alt="${team2Name} Jersey" class="w-12 h-12 rounded-full object-cover border-2 border-white/20">
                </div>

                <!-- Match info (center) -->
                <div class="flex-1 text-center">
                  <h4 class="text-lg font-semibold text-white">${team1Name} vs ${team2Name}</h4>
                  <div class="flex items-center justify-center gap-4 text-sm text-gray-400 mt-1">
                    <span class="flex items-center">
                      <i class="fas fa-calendar mr-1 text-purple-400"></i>
                      ${match.date}
                    </span>
                    <span class="flex items-center">
                      <i class="fas fa-map-marker-alt mr-1 text-blue-400"></i>
                      ${match.location || 'N/A'}
                    </span>
                    <span class="flex items-center">
                      <i class="fas fa-clock mr-1 text-yellow-400"></i>
                      Week ${match.week || 'N/A'}
                    </span>
                  </div>
                </div>

                <!-- Action (right) -->
                <div class="w-40 flex justify-end">
                  <button class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-700 text-white rounded-lg font-semibold hover:from-blue-600 hover:to-blue-800 transition-all view-score-btn" onclick="viewMatchReport(${match.id})">View Score</button>
                </div>
              </div>
            </div>
          `;
        })
        .join('');
    }

    function applyCompletedMatchesFilters() {
      if (!completedMatchesData) {
        return [];
      }

      const filters = {
        status: document.getElementById('filterCompletedMatchStatus')?.value || '',
        dateFrom: document.getElementById('filterCompletedMatchDateFrom')?.value || '',
        dateTo: document.getElementById('filterCompletedMatchDateTo')?.value || '',
        search: (document.getElementById('filterCompletedMatchSearch')?.value || '').trim().toLowerCase()
      };

      const filteredResults = completedMatchesData.filter(match => {
        // Status filter
        if (filters.status && match.status !== filters.status) {
          return false;
        }

        // Date range filter
        if (filters.dateFrom || filters.dateTo) {
          const matchDate = new Date(match.date);
          if (filters.dateFrom) {
            const fromDate = new Date(filters.dateFrom);
            if (matchDate < fromDate) {
              return false;
            }
          }
          if (filters.dateTo) {
            const toDate = new Date(filters.dateTo);
            if (matchDate > toDate) {
              return false;
            }
          }
        }
        // Search filter (by team name)
        if (filters.search) {
          const t1 = (getTeamNameById(match.team1Id) || '').toLowerCase();
          const t2 = (getTeamNameById(match.team2Id) || '').toLowerCase();
          if (!t1.includes(filters.search) && !t2.includes(filters.search)) {
            return false;
          }
        }

        return true;
      });

      return filteredResults;
    }

    function viewMatchReport(matchId) {
      // Open match report in a modal
      const match = completedMatchesData.find(m => m.id == matchId);
      if (match) {
        // Populate modal with match data
        document.getElementById('matchReportTitle').textContent = 'Match Report';
        document.getElementById('matchReportTeams').textContent = `${getTeamNameById(match.team1Id)} vs ${getTeamNameById(match.team2Id)}`;
        document.getElementById('matchReportDate').textContent = match.date || '-';
        document.getElementById('matchReportLocation').textContent = match.location || '-';
        document.getElementById('matchReportReferee').textContent = match.referee || '-';
        document.getElementById('matchReportScore').textContent = match.final_score || '-';
        document.getElementById('matchReportWeek').textContent = match.week || '-';

        // Statistics
        document.getElementById('matchReportGoals').textContent = match.total_goals || 0;
        document.getElementById('matchReportCards').textContent = match.total_cards || 0;
        document.getElementById('matchReportFouls').textContent = match.total_fouls || 0;

        // Additional information
        const cautionDescEl = document.querySelector('#matchReportCautionDesc .match-report-item-value');
        const additionalNotesEl = document.querySelector('#matchReportAdditionalNotes .match-report-item-value');

        cautionDescEl.textContent = match.caution_desc || '-';
        additionalNotesEl.textContent = match.additional_notes || '-';

        // Show the modal
        document.getElementById('matchReportPopup').classList.add('show');
      }
    }

    // Function to close the match report popup
    function closeMatchReportPopup() {
      document.getElementById('matchReportPopup').classList.remove('show');
    }

    // Event listener for popup close button (guarded in case script runs before DOM is ready)
    (function(){
      const matchReportCloseBtn = document.getElementById('matchReportCloseBtn');
      if (matchReportCloseBtn) {
        matchReportCloseBtn.addEventListener('click', closeMatchReportPopup);
      }

      // Close popup when clicking outside the modal (guarded)
      const matchReportPopupEl = document.getElementById('matchReportPopup');
      if (matchReportPopupEl) {
        matchReportPopupEl.addEventListener('click', function(e) {
          if (e.target === this) {
            closeMatchReportPopup();
          }
        });
      }
    })();

    // Completed Matches filter toggle and event listeners
    const completedMatchesFilterToggle = document.getElementById('completedMatchesFilterToggle');
    const completedMatchesFilters = document.getElementById('completedMatchesFilters');
    const refreshCompletedMatchesBtn = document.getElementById('refreshCompletedMatchesBtn');

    if (completedMatchesFilterToggle && completedMatchesFilters) {
      completedMatchesFilterToggle.addEventListener('click', function () {
        completedMatchesFilters.classList.toggle('hidden');
        const icon = this.querySelector('i');
        if (icon) {
          icon.classList.toggle('fa-chevron-down');
          icon.classList.toggle('fa-chevron-up');
        }
      });

      // Add event listeners to filter elements
      ['filterCompletedMatchStatus', 'filterCompletedMatchDateFrom', 'filterCompletedMatchDateTo'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('change', renderCompletedMatches);
        }
      });

      // Search input - trigger render on input (debounced simple)
      const searchInput = document.getElementById('filterCompletedMatchSearch');
      if (searchInput) {
        let searchTimeout = null;
        searchInput.addEventListener('input', function () {
          if (searchTimeout) clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            renderCompletedMatches();
          }, 250);
        });
      }

      // Clear filters button
      const clearBtn = document.getElementById('clearCompletedMatchFilters');
      if (clearBtn) {
        clearBtn.addEventListener('click', function () {
          // Reset filter inputs
          const statusEl = document.getElementById('filterCompletedMatchStatus'); if (statusEl) statusEl.value = '';
          const dateFromEl = document.getElementById('filterCompletedMatchDateFrom'); if (dateFromEl) dateFromEl.value = '';
          const dateToEl = document.getElementById('filterCompletedMatchDateTo'); if (dateToEl) dateToEl.value = '';
          const searchEl = document.getElementById('filterCompletedMatchSearch'); if (searchEl) searchEl.value = '';
          renderCompletedMatches();
        });
      }
    }

    if (refreshCompletedMatchesBtn) {
      refreshCompletedMatchesBtn.addEventListener('click', function () {
        fetchCompletedMatches();
      });
    }

    // --- Referees Management Logic ---
    function resetRefereeForm() {
      refUserId.value = "";
      refFirstName.value = "";
      refLastName.value = "";
      refEmail.value = "";
      refUsername.value = "";
      refPassword.value = "";
      refFormTitle.textContent = "Create Referee";
      refCancelEditBtn.classList.add("hidden");
    }

    function renderRefereesList(list) {
      if (!Array.isArray(list) || list.length === 0) {
        refereesList.innerHTML = '<div class="text-center py-8 text-gray-400">No referees found.</div>';
        return;
      }
      refereesList.innerHTML = list.map(u => `
          <div class="bg-white/5 border border-white/10 rounded-xl p-4 flex items-center justify-between group">
            <div>
              <p class="text-white font-medium">${u.name || (u.first_name || '') + ' ' + (u.last_name || '')}</p>
              <p class="text-gray-400 text-xs">${u.user_email}  ${u.user_login}</p>
            </div>
            <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
              <button class="p-2 text-blue-400 hover:text-blue-300" onclick='editReferee(${JSON.stringify(u).replace(/'/g, "&#39;")})'>
                <i class="fas fa-edit"></i>
              </button>
              <button class="p-2 text-red-400 hover:text-red-300" onclick="deleteReferee(${u.id})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `).join("");
    }

    function fetchRefereesFull() {
      jQuery.ajax({
        url: your_plugin_ajax_object.ajax_url,
        type: 'POST',
        data: { action: 'your_plugin_fetch_referees_full', nonce: your_plugin_ajax_object.nonce },
        success: function (resp) { if (resp.success) renderRefereesList(resp.data); },
        error: function () { showNotification('Failed to load referees.', 'error'); }
      });
    }

    function fetchRefereeStats() {
      jQuery.ajax({
        url: your_plugin_ajax_object.ajax_url,
        type: 'POST',
        data: { action: 'your_plugin_fetch_referee_stats', nonce: your_plugin_ajax_object.nonce },
        success: function (resp) {
          if (resp.success) {
            const d = resp.data || {};
            totalRefereesEl.textContent = d.total_referees || 0;
            refMatchesAssignedEl.textContent = d.matches_assigned || 0;
            refUpcomingEl.textContent = d.upcoming_matches || 0;
            refCompletedEl.textContent = d.completed_matches || 0;
          }
        }
      });
    }

    function editReferee(user) {
      refUserId.value = user.id;
      refFirstName.value = user.first_name || '';
      refLastName.value = user.last_name || '';
      refEmail.value = user.user_email || '';
      refUsername.value = user.user_login || '';
      refPassword.value = '';
      refFormTitle.textContent = 'Edit Referee';
      refCancelEditBtn.classList.remove('hidden');
      pageTitle.textContent = 'Edit Referee';
      pageDescription.textContent = 'Update referee details';
    }
    window.editReferee = editReferee;

    function deleteReferee(userId) {
      if (!confirm('Delete this referee?')) return;
      jQuery.ajax({
        url: your_plugin_ajax_object.ajax_url,
        type: 'POST',
        data: { action: 'your_plugin_delete_referee', nonce: your_plugin_ajax_object.nonce, user_id: userId },
        success: function (resp) {
          if (resp.success) { showNotification('Referee deleted.', 'success'); fetchRefereesFull(); fetchRefereeStats(); }
          else { showNotification(resp.data && resp.data.message ? resp.data.message : 'Failed to delete referee.', 'error'); }
        },
        error: function () { showNotification('Failed to delete referee.', 'error'); }
      });
    }
    window.deleteReferee = deleteReferee;

    if (refForm) {
      refForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const payload = {
          nonce: your_plugin_ajax_object.nonce,
          first_name: refFirstName.value.trim(),
          last_name: refLastName.value.trim(),
          user_email: refEmail.value.trim(),
          user_login: refUsername.value.trim(),
          user_pass: refPassword.value.trim(),
        };
        const isEdit = !!refUserId.value;
        if (isEdit) { payload.action = 'your_plugin_update_referee'; payload.user_id = refUserId.value; }
        else { payload.action = 'your_plugin_create_referee'; }
        jQuery.ajax({
          url: your_plugin_ajax_object.ajax_url,
          type: 'POST',
          data: payload,
          success: function (resp) {
            if (resp.success) {
              showNotification(isEdit ? 'Referee updated.' : 'Referee created.', 'success');
              resetRefereeForm();
              fetchRefereesFull();
              fetchRefereeStats();
              // Also refresh matches tab referee dropdown
              if (typeof populateRefereeSelect === 'function') { try { populateRefereeSelect(); } catch (e) { } }
            } else {
              showNotification(resp.data && resp.data.message ? resp.data.message : 'Operation failed.', 'error');
            }
          },
          error: function () { showNotification('Operation failed.', 'error'); }
        });
      });
      refCancelEditBtn.addEventListener('click', function () { resetRefereeForm(); pageTitle.textContent = 'Referee Management'; pageDescription.textContent = 'Create, edit, and manage referees'; });
    }
    if (refreshRefereesBtn) { refreshRefereesBtn.addEventListener('click', function () { fetchRefereesFull(); fetchRefereeStats(); }); }

    // --- Players Management Logic ---
    let playersData = [];

    function fetchPlayersData() {
      jQuery.ajax({
        url: your_plugin_ajax_object.ajax_url,
        type: 'POST',
        data: {
          action: 'your_plugin_fetch_all_players_stats',
          nonce: your_plugin_ajax_object.nonce
        },
        success: function (response) {
          if (response.success) {
            playersData = response.data.players || [];
            renderPlayersTable();
            updatePlayersStats(response.data.stats || {});
            populatePlayersFilterOptions();
          } else {
            showNotification('Failed to load players data.', 'error');
          }
        },
        error: function () {
          showNotification('Failed to load players data.', 'error');
        }
      });
    }

    function updatePlayersStats(stats) {
      // Use stats from backend response
      totalPlayersEl.textContent = stats.total_players || playersData.length;
      totalGoalsEl.textContent = stats.total_goals || 0;
      totalCardsEl.textContent = stats.total_cards || 0;
      activePlayersEl.textContent = stats.active_players || playersData.length;
    }

    function renderPlayersTable() {
      if (!playersData || playersData.length === 0) {
        playersTableBody.innerHTML = `
            <tr>
              <td colspan="8" class="text-center py-12 text-gray-400">
                <i class="fas fa-user w-16 h-16 mx-auto mb-4 opacity-50 text-6xl"></i>
                <p class="text-lg">No players found</p>
                <p class="text-sm">Player data will appear here once matches are played</p>
              </td>
            </tr>
          `;
        return;
      }

      // Apply filters
      const filteredPlayers = applyPlayerFilters();

      if (filteredPlayers.length === 0) {
        playersTableBody.innerHTML = `
            <tr>
              <td colspan="8" class="text-center py-8 text-gray-400">
                <p>No players match the current filters</p>
              </td>
            </tr>
          `;
        return;
      }

      // Render each player individually - no team expansion needed
      playersTableBody.innerHTML = filteredPlayers.map(player => `
          <tr class="border-b border-white/10 hover:bg-white/5 transition-colors">
            <td class="py-3 px-4">
              <div class="flex items-center">
                <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-xs font-bold mr-3">
                  ${player.name ? player.name.substring(0, 2).toUpperCase() : 'N/A'}
                </div>
                <div>
                  <div class="font-medium text-white">${player.name || 'Unknown'}</div>
                  <div class="text-xs text-gray-400">ID: ${player.player_id || player.id}</div>
                </div>
              </div>
            </td>
            <td class="text-center py-3 px-4 text-gray-300">${player.team_name || 'Unknown'}</td>
            <td class="text-center py-3 px-4 font-semibold text-blue-400">${player.games_played || 0}</td>
            <td class="text-center py-3 px-4 font-semibold text-red-400">${player.injuries || 0}</td>
            <td class="text-center py-3 px-4 font-semibold text-blue-500">${player.blue_cards || 0}</td>
            <td class="text-center py-3 px-4 font-semibold text-yellow-500">${player.yellow_cards || 0}</td>
            <td class="text-center py-3 px-4 font-semibold text-red-500">${player.red_cards || 0}</td>
            <td class="text-center py-3 px-4 font-semibold text-green-400">${player.goals || 0}</td>
          </tr>
        `).join('');
    }

    function applyPlayerFilters() {
      if (!playersData) {
        return [];
      }

      const filters = {
        team: filterPlayerTeam.value || '',
        season: filterPlayerSeason.value || '',
        name: filterPlayerName.value.toLowerCase().trim() || ''
      };

      const filteredResults = playersData.filter(player => {
        // Team filter - check if player belongs to selected team
        if (filters.team) {
          const playerTeamId = player.team_id ? parseInt(player.team_id) : null;
          if (playerTeamId !== parseInt(filters.team)) {
            return false;
          }
        }

        // Name filter
        if (filters.name && (!player.name || !player.name.toLowerCase().includes(filters.name))) {
          return false;
        }

        // Season filter - check if player's team matches the season
        if (filters.season) {
          const playerTeamId = player.team_id ? parseInt(player.team_id) : null;
          if (playerTeamId) {
            const team = teams.find(t => t.id === playerTeamId);
            if (!team || team.team_season !== filters.season) {
              return false;
            }
          } else {
            // If no team_id, exclude from season filter
            return false;
          }
        }

        return true;
      });

      return filteredResults;
    }

    function populatePlayersFilterOptions() {
      // Populate team filter based on actual player data
      if (filterPlayerTeam) {
        const currentTeamValue = filterPlayerTeam.value;
        const teamIds = Array.from(new Set(
          playersData.map(player => player.team_id).filter(id => id != null)
        )).sort((a, b) => a - b);

        const teamOptions = teamIds.map(teamId => {
          const team = teams.find(t => t.id === parseInt(teamId));
          return `<option value="${teamId}">${team ? team.name : `Team ${teamId}`}</option>`;
        }).join('');

        filterPlayerTeam.innerHTML = '<option value="">All Teams</option>' + teamOptions;
        if (currentTeamValue && teamIds.includes(parseInt(currentTeamValue))) {
          filterPlayerTeam.value = currentTeamValue;
        }
      }

      // Populate season filter based on teams that have players
      if (filterPlayerSeason) {
        const currentSeasonValue = filterPlayerSeason.value;
        const playerTeamIds = Array.from(new Set(
          playersData.map(player => player.team_id).filter(id => id != null)
        ));

        const seasons = Array.from(new Set(
          teams.filter(team => playerTeamIds.includes(team.id))
               .map(t => (t.team_season || '').toString().trim())
               .filter(v => v !== '')
        )).sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));

        filterPlayerSeason.innerHTML = '<option value="">All Seasons</option>' +
          seasons.map(v => `<option value="${v}">${v}</option>`).join('');
        if (currentSeasonValue && seasons.includes(currentSeasonValue)) {
          filterPlayerSeason.value = currentSeasonValue;
        }
      }
    }

    // Players filter toggle and event listeners
    if (playersFilterToggle && playersFilters) {
      playersFilterToggle.addEventListener('click', function () {
        playersFilters.classList.toggle('hidden');
      });

      // Add event listeners to all filter elements
      [filterPlayerTeam, filterPlayerSeason, filterPlayerName].forEach(element => {
        if (element) {
          element.addEventListener('change', renderPlayersTable);
          if (element.type === 'text') {
            element.addEventListener('input', renderPlayersTable);
          }
        }
      });
    }

    // --- Team Management and Member Addition Logic ---

    // Function to render the list of added members in the "Create Team" form
    function renderAddedMembers() {
      if (currentTeamMembers.length === 0) {
        addedMembersList.innerHTML =
          '<p class="text-center text-gray-400 italic">No members added yet.</p>';
        return;
      }

      addedMembersList.innerHTML = currentTeamMembers
        .map(
          (member, index) => `
        <div class="bg-white/5 border border-white/10 rounded-xl p-4 flex items-center justify-between group" data-member-id="${member.id}">
            <div>
                <p class="text-white font-medium">${member.name}</p>
                <p class="text-gray-400 text-xs">ID: ${member.id}</p>
            </div>
            <div class="flex items-center space-x-2">
                <!-- Edit Button - Also uses group-hover -->
                <button type="button" class="text-blue-400 hover:text-blue-300 transition-colors opacity-0 group-hover:opacity-100" onclick="editMember(${index})">
                    <i class="fas fa-edit"></i>
                </button>
                <!-- Delete Button - Already had group-hover -->
                <button type="button" class="text-red-500 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100" onclick="removeCurrentMember(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `
        )
        .join("");
    }

    // Function to remove a member from the current team being created
    function removeCurrentMember(index) {
      currentTeamMembers.splice(index, 1);
      renderAddedMembers();
    }

    // Function to set up the form for editing a member
    function editMember(index) {
      editingMemberIndex = index;
      const member = currentTeamMembers[index];
      playerIdInput.value = member.id;
      playerNameInput.value = member.name;
      addMemberButton.textContent = "Update Member"; // Change button text
      addMemberButton.classList.remove(
        "bg-gradient-to-br",
        "from-purple-600",
        "to-pink-600"
      );
      addMemberButton.classList.add(
        "bg-gradient-to-br",
        "from-green-500",
        "to-teal-500"
      ); // Change button style for update
    }

    // Function to reset the form back to "Add Member" mode
    function resetMemberForm() {
      editingMemberIndex = -1;
      playerIdInput.value = "";
      playerNameInput.value = "";
      addMemberButton.textContent = "Add Member";
      addMemberButton.classList.remove(
        "bg-gradient-to-br",
        "from-green-500",
        "to-teal-500"
      );
      addMemberButton.classList.add(
        "bg-gradient-to-br",
        "from-purple-600",
        "to-pink-600"
      );
    }

    // Event listener for the "Add Member" / "Update Member" button
    addMemberButton.addEventListener("click", () => {
      const playerId = playerIdInput.value.trim();
      const playerName = playerNameInput.value.trim();

      if (playerId && playerName) {
        if (editingMemberIndex === -1) {
          // Adding a new member
          if (currentTeamMembers.some((member) => member.id === playerId)) {
            showNotification(
              `Player with ID "${playerId}" is already added to this team.`,
              "error"
            );
            return;
          }
          currentTeamMembers.push({ id: playerId, name: playerName });
        } else {
          // Updating an existing member
          currentTeamMembers[editingMemberIndex].id = playerId;
          currentTeamMembers[editingMemberIndex].name = playerName;
          resetMemberForm(); // Reset form after update
        }
        renderAddedMembers();

        playerIdInput.value = "";
        playerNameInput.value = "";
        playerIdInput.focus();
      } else {
        showNotification(
          "Please enter both Player ID and Player Name.",
          "error"
        );
      }
    });

    // Function to load team data into the form for editing
    function editTeam(teamId) {
      const team = teams.find((t) => t.id === teamId);
      if (!team) {
        showNotification("Team not found.", "error");
        return;
      }

      // Populate form fields
      teamNameInput.value = team.name;
      teamLocationInput.value = team.team_location || '';
      teamDayInput.value = team.team_day || '';
      teamLeagueInput.value = team.team_league || '';
      teamDivisionInput.value = team.team_division || '';
      teamSeasonInput.value = team.team_season || '';
      teamYearInput.value = team.team_year || '';

      // Show jersey preview
      if (team.jersey_image_url) {
        jerseyImagePreview.src = team.jersey_image_url;
        jerseyImagePreviewContainer.classList.remove("hidden");
      } else {
        jerseyImagePreviewContainer.classList.add("hidden");
      }
      // Make jersey image not required for updates
      teamJerseyImageInput.required = false;

      // Load members into the currentTeamMembers array
      currentTeamMembers = [...team.members]; // Create a copy to avoid modifying the original team directly
      renderAddedMembers(); // Render the loaded members

      // Change form to "Edit Team" mode
      editingTeamId = teamId; // Store the ID of the team being edited
      pageTitle.textContent = "Edit Team"; // Change page title
      pageDescription.textContent = `Editing team: ${team.name}`; // Update description
      createTeamButton.textContent = "Update Team"; // Change button text
    }

    // Function to populate the team select dropdowns for match creation
    function populateTeamSelects() {
      // Make an AJAX call to fetch teams from the server
      jQuery.ajax({
        url: your_plugin_ajax_object.ajax_url,
        type: "POST",
        data: {
          action: "your_plugin_fetch_teams", // WordPress AJAX action hook
          nonce: your_plugin_ajax_object.nonce,
        },
        success: function (response) {
          if (response.success) {
            teams = response.data; // Update the frontend 'teams' array with server data
            updateStats(); // Update the stats based on fetched data

            if (teams.length === 0) {
              team1Select.innerHTML =
                '<option value="" disabled selected hidden>No teams available</option>';
              team2Select.innerHTML =
                '<option value="" disabled selected hidden>No teams available</option>';
            } else {
              const teamOptions = teams
                .map(
                  (team) => `<option value="${team.id}">${team.name}</option>`
                )
                .join("");
              team1Select.innerHTML = `<option value="" disabled selected hidden>Select Team 1</option>${teamOptions}`;
              team2Select.innerHTML = `<option value="" disabled selected hidden>Select Team 2</option>${teamOptions}`;
              applyMatchTeamFilters();
            }
            renderTeams(); // Render teams list from server data
            // Repopulate filter dropdowns after teams are loaded
            if (typeof populateTeamsFilterOptions === 'function') {
              populateTeamsFilterOptions();
            }
            if (typeof populateMatchesFilterOptions === 'function') {
              populateMatchesFilterOptions();
            }
            updateMatchStats(); // Update match stats (if matches are also fetched/managed)
          } else {
            showNotification(
              response.data.message || "Failed to load teams.",
              "error"
            );
          }
        },
        error: function (error) {
          showNotification(
            "An error occurred while fetching teams.",
            "error"
          );
          console.error("AJAX Error:", error);
        },
      });
    }

    // Function to fetch and render matches from backend
    function fetchAndRenderMatches() {
      jQuery.ajax({
        url: your_plugin_ajax_object.ajax_url,
        type: "POST",
        data: {
          action: "your_plugin_fetch_matches",
          nonce: your_plugin_ajax_object.nonce,
        },
        success: function (response) {
          if (response.success && Array.isArray(response.data)) {
            matches = response.data;
            renderMatches();
            updateMatchStats();
          } else {
            showNotification("Failed to load matches.", "error");
          }
        },
        error: function () {
          showNotification(
            "An error occurred while fetching matches.",
            "error"
          );
        },
      });
    }

    // Function to render the list of matches
    function renderMatches() {
      const container = matchesListContainer;
      if (matches.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12 text-gray-400">
                <i class="fas fa-inbox w-16 h-16 mx-auto mb-4 opacity-50 text-6xl"></i>
                <p class="text-lg">No matches scheduled yet</p>
                <p class="text-sm">Create your first match to get started</p>
            </div>
        `;
        return;
      }

      container.innerHTML = matches
        .map(
          (match) => `
        <div class="bg-white/5 border border-white/10 rounded-xl p-6 hover:bg-white/10 transition-all duration-300 group relative">
            <div class="flex flex-col md:flex-row items-start justify-between mb-4">
                <div class="flex-1">
                    <h4 class="text-xl font-semibold text-white mb-2">${getTeamNameById(
            match.team1Id
          )} vs ${getTeamNameById(match.team2Id)}</h4>
                    <div class="flex flex-wrap gap-4 text-sm text-gray-400">
                        <span class="flex items-center">
                            <i class="fas fa-calendar mr-1 text-purple-400"></i>
                            ${match.date}
                        </span>
                        <span class="flex items-center">
                            <i class="fas fa-map-marker-alt mr-1 text-blue-400"></i>
                            ${match.location || "N/A"}
                        </span>
                        <span class="flex items-center">
                            <i class="fas fa-user mr-1 text-green-400"></i>
                            ${match.referee || "Not assigned"}
                        </span>
                        <span class="flex items-center">
                            <i class="fas fa-clock mr-1 text-yellow-400"></i>
                            Week ${match.week || "N/A"}
                        </span>
                    </div>
                </div>
                <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity md:ml-4 mt-4 md:mt-0">
                    <!-- Start Match Button -->
                    <!-- Start Match Button removed: now only available in referee dashboard -->
                    <!-- Edit Button for Match Card -->
                    <button class="p-2 text-gray-400 hover:text-blue-400 transition-colors" onclick="editMatch(${match.id
            })">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="p-2 text-gray-400 hover:text-red-400 transition-colors" onclick="deleteMatch(${match.id
            })">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `
        )
        .join("");
    }

    // Helper to get team name by ID
    function getTeamNameById(teamId) {
      // Ensure teamId is treated as a number for comparison
      const team = teams.find((t) => t.id === parseInt(teamId));
      return team ? team.name : "Unknown Team";
    }

    // Helper to get team jersey image URL by ID (falls back to placeholder)
    function getTeamJerseyById(teamId) {
      const team = teams.find((t) => t.id === parseInt(teamId));
      return team && team.jersey_image_url ? team.jersey_image_url : 'https://via.placeholder.com/80';
    }

    // Match Form Submission Handler
    createMatchForm.addEventListener("submit", function (e) {
      e.preventDefault(); // Prevent default form submission

      const team1Id = team1Select.value;
      const team2Id = team2Select.value;
      const date = matchDateInput.value;
      const location = matchLocationInput.value.trim();
      const week = parseInt(matchWeekInput.value.trim());
      const referee = matchRefereeInput.value.trim();

      // Basic Validation
      if (!team1Id || !team2Id || !date) {
        showNotification("Please select both teams and a date.", "error");
        return;
      }
      if (team1Id === team2Id) {
        showNotification("A team cannot play against itself.", "error");
        return;
      }
      if (isNaN(week) || week <= 0) {
        showNotification(
          "Please enter a valid week number (e.g., 1, 2, 3...).",
          "error"
        );
        return;
      }
      if (!referee) {
        showNotification("Please select a referee.", "error");
        return;
      }

      // Determine if creating or updating
      const ajaxAction = editingMatchId
        ? "your_plugin_update_match"
        : "your_plugin_create_match";
      const ajaxData = {
        action: ajaxAction,
        nonce: your_plugin_ajax_object.nonce,
        team1_id: team1Id,
        team2_id: team2Id,
        match_date: date,
        match_location: location,
        match_week: week,
        referee_id: referee,
      };
      if (editingMatchId) {
        ajaxData.match_id = editingMatchId;
      }

      jQuery.ajax({
        url: your_plugin_ajax_object.ajax_url,
        type: "POST",
        data: ajaxData,
        success: function (response) {
          if (response.success) {
            showNotification(
              editingMatchId
                ? "Match updated successfully!"
                : "Match created successfully!",
              "success"
            );
            createMatchForm.reset();
            team1Select.value = "";
            team2Select.value = "";
            populateTeamSelects();
            fetchAndRenderMatches();
            editingMatchId = null;
            matchFormTitle.textContent = "Create New Match";
            matchSubmitButton.textContent = "Create Match";
          } else {
            showNotification(
              response.data && response.data.message
                ? response.data.message
                : "An error occurred.",
              "error"
            );
          }
        },
        error: function () {
          showNotification("An AJAX error occurred.", "error");
        },
      });
    });

    // Update editMatch to set editingMatchId
    function editMatch(matchId) {
      const match = matches.find((m) => m.id == matchId);
      if (!match) {
        showNotification("Match not found.", "error");
        return;
      }
      team1Select.value = match.team1Id;
      team2Select.value = match.team2Id;
      matchDateInput.value = match.date;
      matchLocationInput.value = match.location;
      matchWeekInput.value = match.week;
      // Ensure referee select uses the refereeId not name
      if (match.refereeId) { matchRefereeInput.value = match.refereeId; }
      editingMatchId = matchId;
      matchFormTitle.textContent = "Edit Match";
      matchSubmitButton.textContent = "Update Match";
    }

    // Match Delete Functionality
    function deleteMatch(matchId) {
      if (confirm("Are you sure you want to delete this match?")) {
        jQuery.ajax({
          url: your_plugin_ajax_object.ajax_url,
          type: "POST",
          data: {
            action: "your_plugin_delete_match",
            nonce: your_plugin_ajax_object.nonce,
            match_id: matchId,
          },
          success: function (response) {
            if (response.success) {
              showNotification("Match deleted successfully!", "success");
              fetchAndRenderMatches();
            } else {
              showNotification(
                response.data && response.data.message
                  ? response.data.message
                  : "Failed to delete match.",
                "error"
              );
            }
          },
          error: function () {
            showNotification(
              "An error occurred while deleting the match.",
              "error"
            );
          },
        });
      }
    }

    /*
     */

    function startMatch(matchId) {
      const match = matches.find((m) => m.id === matchId);
      if (match) {
        const team1 = teams.find((t) => t.id == match.team1Id);
        const team2 = teams.find((t) => t.id == match.team2Id);
        const team1Name = team1 ? team1.name : "Unknown Team";
        const team2Name = team2 ? team2.name : "Unknown Team";

        function buildDatalistOptions(members) {
          return (members || [])
            .map(
              (member) =>
                `<option value="${member.id}">${member.name}</option>`
            )
            .join("");
        }

        const teamIconSVG = `
            <i class="fas fa-users mr-3 text-blue-400"></i>
          `;

        const cardFormHTML = [
          // Card 0: Team 1
          `
            <form class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 mt-4">
              <input 
                type="text" 
                list="playerIdsTeam1"
                class="w-full sm:w-32 px-3 py-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400" 
                placeholder="Player ID" 
              />
              <datalist id="playerIdsTeam1">
                ${buildDatalistOptions(team1 ? team1.members : [])}
              </datalist>
              <button type="button" class="w-full sm:w-auto px-3 py-2 rounded-lg bg-green-500 text-white font-semibold hover:bg-green-600 transition text-xs">Goal</button>
              <button type="button" class="w-full sm:w-auto px-3 py-2 rounded-lg bg-blue-500 text-white font-semibold hover:bg-blue-600 transition text-xs">Blue Card</button>
              <button type="button" class="w-full sm:w-auto px-3 py-2 rounded-lg bg-yellow-500 text-white font-semibold hover:bg-yellow-600 transition text-xs">Yellow Card</button>
              <button type="button" class="w-full sm:w-auto px-3 py-2 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 transition text-xs">Red Card</button>
            </form>
            `,
          // Card 1: Team 2
          `
            <form class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 mt-4">
              <input 
                type="text" 
                list="playerIdsTeam2"
                class="w-full sm:w-32 px-3 py-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400" 
                placeholder="Player ID" 
              />
              <datalist id="playerIdsTeam2">
                ${buildDatalistOptions(team2 ? team2.members : [])}
              </datalist>
              <button type="button" class="w-full sm:w-auto px-3 py-2 rounded-lg bg-green-500 text-white font-semibold hover:bg-green-600 transition text-xs">Goal</button>
              <button type="button" class="w-full sm:w-auto px-3 py-2 rounded-lg bg-blue-500 text-white font-semibold hover:bg-blue-600 transition text-xs">Blue Card</button>
              <button type="button" class="w-full sm:w-auto px-3 py-2 rounded-lg bg-yellow-500 text-white font-semibold hover:bg-yellow-600 transition text-xs">Yellow Card</button>
              <button type="button" class="w-full sm:w-auto px-3 py-2 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 transition text-xs">Red Card</button>
            </form>
            `,
        ];

        function renderPlayerEventsTable(container, playerEvents, teamGoals) {
          // CORRECTED: Always show at least 8 columns, or more if more goals are scored.
          const goalColumnCount = Math.max(8, teamGoals.length);

          let table = `
              <table class="min-w-full text-xs text-white border border-white/10 rounded-lg overflow-hidden mt-6">
                <thead>
                  <tr>
                    <th class="px-2 py-1 border-b border-white/10">Player ID</th>
                    ${[...Array(goalColumnCount)]
              .map(
                (_, i) =>
                  `<th class="px-2 py-1 border-b border-white/10">${i + 1
                  }</th>`
              )
              .join("")}
                    <th class="px-2 py-1 border-b border-white/10 text-blue-400">Blue Card</th>
                    <th class="px-2 py-1 border-b border-white/10 text-yellow-400">Yellow Card</th>
                    <th class="px-2 py-1 border-b border-white/10 text-red-400">Red Card</th>
                  </tr>
                </thead>
                <tbody>
                  ${playerEvents
              .map(
                (ev) => `
                    <tr>
                      <td class="px-2 py-1 border-b border-white/10 text-center">${ev.id
                  }</td>
                      ${
                  /* CORRECTED: Loop through the required number of columns */
                  Array.from({ length: goalColumnCount }, (_, i) => {
                    const scorerId = teamGoals[i]; // Get scorer for this goal index
                    return `<td class="px-2 py-1 border-b border-white/10 text-center">
                            <label class="custom-checkbox">
                              <input type="checkbox" disabled ${scorerId && scorerId === ev.id ? "checked" : ""
                      }>
                              <span></span>
                            </label>
                          </td>`;
                  }).join("")
                  }
                      <td class="px-2 py-1 border-b border-white/10 text-center"><label class="custom-checkbox blue-checkbox">
                        <input type="checkbox" disabled ${ev.blue ? "checked" : ""
                  }>
                        <span></span>
                      </label></td>
                      <td class="px-2 py-1 border-b border-white/10 text-center"><label class="custom-checkbox yellow-checkbox">
                        <input type="checkbox" disabled ${ev.yellow ? "checked" : ""
                  }>
                        <span></span>
                      </label></td>
                      <td class="px-2 py-1 border-b border-white/10 text-center"><label class="custom-checkbox red-checkbox">
                        <input type="checkbox" disabled ${ev.red ? "checked" : ""
                  }>
                        <span></span>
                      </label></td>
                    </tr>
                  `
              )
              .join("")}
                </tbody>
              </table>
            `;
          container.innerHTML = table;
        }

        matchesFormGrid.classList.add("hidden");
        matchDetailsView.classList.remove("hidden");

        matchDetailsView.innerHTML = `
              <!-- Team 1 Card -->
              <div class="card-hover glassmorphism team-scoring-card rounded-2xl p-6 border border-white/10 flex flex-col">
                <h3 class="text-xl font-bold text-white flex items-center">
                  ${teamIconSVG}
                  <span class="ml-1">${team1Name}</span>
                </h3>
                ${cardFormHTML[0]}
                <div class="player-events-table flex-grow"></div>
              </div>

              <!-- Team 2 Card -->
              <div class="card-hover glassmorphism team-scoring-card rounded-2xl p-6 border border-white/10 flex flex-col">
                <h3 class="text-xl font-bold text-white flex items-center">
                  ${teamIconSVG}
                  <span class="ml-1">${team2Name}</span>
                </h3>
                ${cardFormHTML[1]}
                <div class="player-events-table flex-grow"></div>
              </div>

              <!-- Match Summary Card -->
              <div class="card-hover glassmorphism match-summary-card p-6 rounded-2xl lg:col-span-1">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                  <i class="fas fa-desktop mr-2 text-green-400"></i>
                  Match Summary
                </h3>
                <form id="matchSummaryForm" class="flex flex-col gap-4">
                  <div>
                    <label class="block text-white font-semibold mb-1">Final Score</label>
                    <input type="text" name="final_score" class="w-full px-3 py-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400 text-sm focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="e.g. 3-2" required>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-white font-semibold mb-1">1st Half Fouls</label>
                      <input type="text" name="first_half_fouls" class="w-full px-3 py-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400 text-sm focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="0">
                    </div>
                    <div>
                      <label class="block text-white font-semibold mb-1">2nd Half Fouls</label>
                      <input type="text" name="second_half_fouls" class="w-full px-3 py-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400 text-sm focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="0">
                    </div>
                  </div>
                  <div>
                    <label class="block text-white font-semibold mb-1">Caution Descriptions</label>
                    <textarea name="caution_desc" rows="2" class="w-full px-3 py-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400 text-sm focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="Describe any cautions..."></textarea>
                  </div>
                  <div>
                    <label class="block text-white font-semibold mb-1">Additional Notes</label>
                    <textarea name="additional_notes" rows="2" class="w-full px-3 py-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400 text-sm focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="Any additional notes..."></textarea>
                  </div>
                  <button type="submit" class="px-4 py-2 rounded-lg bg-green-500 text-white font-semibold hover:bg-green-600 transition text-base mt-2">Save Match</button>
                </form>
              </div>
          `;

        const cardElements =
          matchDetailsView.querySelectorAll(".team-scoring-card");
        cardElements.forEach((card, index) => {
          // Initialize with proper error handling
          card.playerEvents = card.playerEvents || [];
          card.teamGoals = card.teamGoals || [];

          const form = card.querySelector("form");
          const input = form.querySelector('input[type="text"]');
          const buttons = form.querySelectorAll("button");
          const tableContainer = card.querySelector(".player-events-table");

          // Render initial table with safe data
          renderPlayerEventsTable(
            tableContainer,
            card.playerEvents,
            card.teamGoals
          );

          buttons.forEach((btn) => {
            btn.onclick = function (e) {
              e.preventDefault();
              const playerId = input.value.trim();
              if (!playerId) return;

              let player = card.playerEvents.find((ev) => ev.id === playerId);
              if (!player) {
                player = {
                  id: playerId,
                  blue: false,
                  yellow: false,
                  red: false,
                };
                card.playerEvents.push(player);
              }

              // CORRECTED: Simply push the new goal to the array.
              if (btn.textContent.includes("Goal")) {
                card.teamGoals.push(playerId);
              } else if (btn.textContent.includes("Blue")) {
                player.blue = true;
              } else if (btn.textContent.includes("Yellow")) {
                player.yellow = true;
              } else if (btn.textContent.includes("Red")) {
                player.red = true;
              }

              renderPlayerEventsTable(
                tableContainer,
                card.playerEvents,
                card.teamGoals
              );

              input.value = "";
            };
          });
        });

        const matchSummaryForm =
          matchDetailsView.querySelector("#matchSummaryForm");
        matchSummaryForm.onsubmit = function (e) {
          e.preventDefault();
          const finalScore = matchSummaryForm.final_score.value;
          const cautionDesc = matchSummaryForm.caution_desc.value;
          const additionalNotes = matchSummaryForm.additional_notes.value;
          const firstHalfFouls = matchSummaryForm.first_half_fouls.value;
          const secondHalfFouls = matchSummaryForm.second_half_fouls.value;

          const cards =
            matchDetailsView.querySelectorAll(".team-scoring-card");
          const team1Card = cards[0];
          const team2Card = cards[1];

          function getTeamScoreData(card, teamId) {
            // Handle goals array preserving null positions for proper goal indexing
            const goals = [];
            if (card.teamGoals && Array.isArray(card.teamGoals)) {
              card.teamGoals.forEach((pid, idx) => {
                if (pid && pid !== null && pid !== undefined && pid !== '') {
                  goals.push({ playerId: parseInt(pid), goalIndex: idx + 1 });
                } else {
                  goals.push(null); // Preserve null positions
                }
              });
            }

            const cardsArr = (card.playerEvents || []).map((ev) => ({
              playerId: parseInt(ev.id),
              blue: !!ev.blue,
              yellow: !!ev.yellow,
              red: !!ev.red,
            }));

            return { id: teamId, goals, cards: cardsArr };
          }

          const team1ScoreData = getTeamScoreData(team1Card, match.team1Id);
          const team2ScoreData = getTeamScoreData(team2Card, match.team2Id);

          const scoreData = JSON.stringify({
            team1: team1ScoreData,
            team2: team2ScoreData,
          });

          jQuery.ajax({
            url: your_plugin_ajax_object.ajax_url,
            type: "POST",
            data: {
              action: "save_soccer_match_summary",
              nonce: your_plugin_ajax_object.nonce,
              match_id: matchId,
              final_score: finalScore,
              caution_desc: cautionDesc,
              additional_notes: additionalNotes,
              first_half_fouls: firstHalfFouls,
              second_half_fouls: secondHalfFouls,
              score_data: scoreData,
            },
            success: function (response) {
              if (response.success) {
                showNotification("Match summary saved!", "success");
                fetchAndRenderMatches();
                showTab("matches");
              } else {
                showNotification(
                  response.data.message || "Failed to save match summary.",
                  "error"
                );
              }
            },
            error: function () {
              showNotification("Error saving match summary.", "error");
            },
          });
        };

        showNotification(
          `Starting match: ${team1Name} vs ${team2Name}`,
          "info"
        );
        console.log("Starting match:", match);

        // Try to load existing match data if available
        if (match.score_data) {
          try {
            const scoreData = typeof match.score_data === 'string' ? JSON.parse(match.score_data) : match.score_data;
            loadExistingMatchData(scoreData, cardElements);
            console.log("Loaded existing match data:", scoreData);
          } catch (error) {
            console.warn("Failed to load existing match data:", error);
          }
        } else {
          console.log("No existing score data found for match:", match.id);
        }

        // Also populate form fields if match has existing form data
        setTimeout(() => {
          populateMatchFormFields(match);
        }, 100);

      } else {
        showNotification("Match not found!", "error");
      }
    }

    // Function to populate form fields from match data
    function populateMatchFormFields(matchData) {
      try {
        const matchSummaryForm = document.querySelector("#matchSummaryForm");
        if (!matchSummaryForm) {
          console.warn("Match summary form not found");
          return;
        }

        if (!matchData) {
          console.warn("No match data provided to populate form fields");
          return;
        }

        console.log("Populating form fields with data:", matchData);

        // Populate form fields with null checking
        if (matchData.final_score && matchSummaryForm.final_score) {
          matchSummaryForm.final_score.value = matchData.final_score;
          console.log("Set final_score:", matchData.final_score);
        }
        if (matchData.caution_desc && matchSummaryForm.caution_desc) {
          matchSummaryForm.caution_desc.value = matchData.caution_desc;
          console.log("Set caution_desc:", matchData.caution_desc);
        }
        if (matchData.additional_notes && matchSummaryForm.additional_notes) {
          matchSummaryForm.additional_notes.value = matchData.additional_notes;
          console.log("Set additional_notes:", matchData.additional_notes);
        }
        if (matchData.first_half_fouls && matchSummaryForm.first_half_fouls) {
          matchSummaryForm.first_half_fouls.value = matchData.first_half_fouls;
          console.log("Set first_half_fouls:", matchData.first_half_fouls);
        }
        if (matchData.second_half_fouls && matchSummaryForm.second_half_fouls) {
          matchSummaryForm.second_half_fouls.value = matchData.second_half_fouls;
          console.log("Set second_half_fouls:", matchData.second_half_fouls);
        }

        console.log("Form fields populated successfully");
      } catch (error) {
        console.error("Error populating form fields:", error);
      }
    }

    // Function to load existing match data when viewing/editing completed matches
    function loadExistingMatchData(scoreData, cardElements) {
      try {
        if (!scoreData || !cardElements) return;

        console.log("Loading score data:", scoreData);

        // Load team1 data
        if (scoreData.team1 && cardElements[0]) {
          const team1Card = cardElements[0];
          console.log("Loading team1 data:", scoreData.team1);

          // Load goals with null checking - filter out null values
          if (scoreData.team1.goals && Array.isArray(scoreData.team1.goals)) {
            team1Card.teamGoals = [];
            scoreData.team1.goals.forEach((goal, index) => {
              if (goal && goal.playerId) {
                // Add the playerId to the correct position in the array
                while (team1Card.teamGoals.length <= index) {
                  team1Card.teamGoals.push(null);
                }
                team1Card.teamGoals[index] = goal.playerId.toString();
              }
            });
            // Remove trailing nulls
            while (team1Card.teamGoals.length > 0 && team1Card.teamGoals[team1Card.teamGoals.length - 1] === null) {
              team1Card.teamGoals.pop();
            }
            console.log("Team1 goals loaded:", team1Card.teamGoals);
          }

          // Load player events with null checking
          if (scoreData.team1.cards && Array.isArray(scoreData.team1.cards)) {
            team1Card.playerEvents = scoreData.team1.cards.map(card => ({
              id: card.playerId ? card.playerId.toString() : '',
              blue: !!card.blue,
              yellow: !!card.yellow,
              red: !!card.red
            })).filter(event => event.id !== '');
            console.log("Team1 cards loaded:", team1Card.playerEvents);
          }

          // Re-render the table
          const tableContainer = team1Card.querySelector(".player-events-table");
          if (tableContainer) {
            renderPlayerEventsTable(tableContainer, team1Card.playerEvents, team1Card.teamGoals);
          }
        }

        // Load team2 data
        if (scoreData.team2 && cardElements[1]) {
          const team2Card = cardElements[1];
          console.log("Loading team2 data:", scoreData.team2);

          // Load goals with null checking - filter out null values
          if (scoreData.team2.goals && Array.isArray(scoreData.team2.goals)) {
            team2Card.teamGoals = [];
            scoreData.team2.goals.forEach((goal, index) => {
              if (goal && goal.playerId) {
                // Add the playerId to the correct position in the array
                while (team2Card.teamGoals.length <= index) {
                  team2Card.teamGoals.push(null);
                }
                team2Card.teamGoals[index] = goal.playerId.toString();
              }
            });
            // Remove trailing nulls
            while (team2Card.teamGoals.length > 0 && team2Card.teamGoals[team2Card.teamGoals.length - 1] === null) {
              team2Card.teamGoals.pop();
            }
            console.log("Team2 goals loaded:", team2Card.teamGoals);
          }

          // Load player events with null checking
          if (scoreData.team2.cards && Array.isArray(scoreData.team2.cards)) {
            team2Card.playerEvents = scoreData.team2.cards.map(card => ({
              id: card.playerId ? card.playerId.toString() : '',
              blue: !!card.blue,
              yellow: !!card.yellow,
              red: !!card.red
            })).filter(event => event.id !== '');
            console.log("Team2 cards loaded:", team2Card.playerEvents);
          }

          // Re-render the table
          const tableContainer = team2Card.querySelector(".player-events-table");
          if (tableContainer) {
            renderPlayerEventsTable(tableContainer, team2Card.playerEvents, team2Card.teamGoals);
          }
        }

        console.log("Match data loading completed");

      } catch (error) {
        console.error("Error loading existing match data:", error);
      }
    }

    // Global compatibility functions for external scoring interface
    window.renderMatchInterfaceInto = window.renderMatchInterfaceInto || function (container, matchId) {
      console.warn("renderMatchInterfaceInto called but not fully implemented. Using fallback.");
      try {
        startMatch(matchId);
      } catch (error) {
        console.error("Error in renderMatchInterfaceInto fallback:", error);
      }
    };

    window.applyTeam = window.applyTeam || function (teamData, container) {
      console.warn("applyTeam called but not implemented. TeamData:", teamData);
      // Fallback implementation to prevent errors
      try {
        if (teamData && teamData.goals && Array.isArray(teamData.goals)) {
          // Safely handle goals array
          const safeGoals = teamData.goals.filter(goal => goal && goal.playerId).map((goal, idx) => ({
            playerId: goal.playerId,
            goalIndex: goal.goalIndex || idx + 1
          }));
          console.log("Processed safe goals:", safeGoals);
        }
      } catch (error) {
        console.error("Error in applyTeam fallback:", error);
      }
    };

    window.openScoreEditPopup = window.openScoreEditPopup || function (matchId) {
      console.log("openScoreEditPopup called for match:", matchId);

      // Make AJAX call to fetch match data - using the same endpoint that currently returns the data
      jQuery.ajax({
        url: your_plugin_ajax_object.ajax_url,
        type: "POST",
        data: {
          action: "your_plugin_fetch_match_details", // This should be the actual action name used
          nonce: your_plugin_ajax_object.nonce,
          match_id: matchId,
        },
        success: function (response) {
          console.log("Match details response:", response);
          if (response.success && response.data) {
            // Load match interface with the fetched data
            loadMatchEditInterface(matchId, response.data);
          } else {
            console.error("Failed to fetch match details:", response);
            // Fallback to existing startMatch function
            try {
              startMatch(matchId);
            } catch (error) {
              console.error("Error in startMatch fallback:", error);
            }
          }
        },
        error: function (xhr, status, error) {
          console.error("AJAX error fetching match details:", error);
          // Fallback to existing startMatch function
          try {
            startMatch(matchId);
          } catch (error) {
            console.error("Error in startMatch fallback:", error);
          }
        }
      });
    };

    // Function to load match edit interface with AJAX response data
    function loadMatchEditInterface(matchId, matchData) {
      console.log("Loading match edit interface with data:", matchData);

      // Find match in local array or use the passed data
      let match = matches.find((m) => m.id === matchId);
      if (!match) {
        // Create a temporary match object from the response data
        match = {
          id: matchId,
          team1Id: matchData.team1_id || matchData.team1Id,
          team2Id: matchData.team2_id || matchData.team2Id,
          date: matchData.date,
          location: matchData.location,
          referee: matchData.referee,
          week: matchData.week,
          // Add form data fields
          final_score: matchData.final_score,
          caution_desc: matchData.caution_desc,
          additional_notes: matchData.additional_notes,
          first_half_fouls: matchData.first_half_fouls,
          second_half_fouls: matchData.second_half_fouls,
          score_data: matchData.score_data
        };
        // Add to matches array temporarily
        matches.push(match);
      } else {
        // Update existing match with form data
        match.final_score = matchData.final_score;
        match.caution_desc = matchData.caution_desc;
        match.additional_notes = matchData.additional_notes;
        match.first_half_fouls = matchData.first_half_fouls;
        match.second_half_fouls = matchData.second_half_fouls;
        match.score_data = matchData.score_data;
      }

      // Start with the regular match interface - this will now populate form fields automatically
      startMatch(matchId);
    }

    // Render teams function (Modified to display members and member count)
    function renderTeams() {
      const container = document.getElementById("teamsList");
      if (teams.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12 text-gray-400">
                <i class="fas fa-users w-16 h-16 mx-auto mb-4 opacity-50 text-6xl"></i>
                <p class="text-lg">No teams created yet</p>
                <p class="text-sm">Create your first team to get started</p>
            </div>
        `;
        return;
      }

      // Apply filters
      const f = {
        location: (document.getElementById('filterLocation')?.value || ''),
        day: (document.getElementById('filterDay')?.value || ''),
        league: (document.getElementById('filterLeague')?.value || ''),
        division: (document.getElementById('filterDivision')?.value || ''),
        season: (document.getElementById('filterSeason')?.value || ''),
        year: (document.getElementById('filterYear')?.value || '')
      };
      const filteredTeams = teams.filter(t => {
        const s = {
          location: (t.team_location || ''),
          day: (t.team_day || ''),
          league: (t.team_league || ''),
          division: (t.team_division || ''),
          season: (t.team_season || ''),
          year: (t.team_year || '')
        };
        return (!f.location || s.location === f.location) &&
          (!f.day || s.day === f.day) &&
          (!f.league || s.league === f.league) &&
          (!f.division || s.division === f.division) &&
          (!f.season || s.season === f.season) &&
          (!f.year || String(s.year) === String(f.year));
      });

      container.innerHTML = filteredTeams
        .map(
          (team) => `
        <div class="bg-white/5 border border-white/10 rounded-xl p-6 hover:bg-white/10 transition-all duration-300 group relative">
            <div class="flex flex-col md:flex-row items-start justify-between mb-4">
                <div class="flex-1 mb-4 md:mb-0">
                    <div class="flex items-center mb-4">
                        <img src="${team.jersey_image_url ||
            "https://via.placeholder.com/80"
            }" alt="${team.name
            } Jersey" class="w-20 h-20 rounded-lg object-cover mr-4 border-2 border-white/20">
                        <div>
                            <h4 class="text-xl font-semibold text-white">${team.name
            }</h4>
                            <div class="text-xs text-gray-400 mt-1">
                              ${[team.team_location, team.team_day, team.team_league, team.team_division, team.team_season, team.team_year].filter(Boolean).join('  ')}
                            </div>
                             <div class="pt-2">
                                <span class="text-sm text-gray-400">${team.members.length
            } member${team.members.length !== 1 ? "s" : ""
            }</span>
                            </div>
                        </div>
                    </div>
                    <!-- Member list -->
                    <div class="flex flex-col space-y-2">
                        <!-- Changed to use Tailwind's grid for two columns -->
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                            ${team.members
              .map(
                (member) => `
                                <div class="flex items-center space-x-3 text-sm text-gray-300">
                                    <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-xs border-2 border-slate-800">
                                        ${member.name
                    .substring(0, 2)
                    .toUpperCase()}
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="font-medium">${member.name}${member.id == 0 ? ' <span class="text-xs bg-green-600 text-white px-1 py-0.5 rounded ml-1">GK</span>' : ''}</span>
                                        <span class="text-xs text-gray-400">ID: ${member.id
                  }</span>
                                    </div>
                                </div>
                            `
              )
              .join("")}
                        </div>
                    </div>
                    <!-- End Member List -->

                </div>
                <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity md:ml-4 mt-4 md:mt-0">
                    <!-- Edit Button for the Team Card -->
                    <button class="p-2 text-gray-400 hover:text-blue-400 transition-colors" onclick="editTeam(${team.id
            })">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="p-2 text-gray-400 hover:text-red-400 transition-colors" onclick="deleteTeam(${team.id
            })">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <!-- Member count footer -->
            <div class="pt-4 border-t border-white/10 mt-4">
                <span class="text-sm text-gray-400">${team.members.length
            } member${team.members.length !== 1 ? "s" : ""}</span>
            </div>
            <!-- End member count footer -->
        </div>
    `
        )
        .join("");
    }

    // Update stats function
    function updateStats() {
      document.getElementById("totalTeams").textContent = teams.length;
      const totalMembers = teams.reduce(
        (sum, team) => sum + team.members.length,
        0
      );
      document.getElementById("totalMembers").textContent = totalMembers;
    }

    // Update match stats function
    function updateMatchStats() {
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Reset time to start of day for accurate comparison

      const totalMatches = matches.length;
      let pendingMatches = 0;
      let completedMatches = 0;

      matches.forEach((match) => {
        if (match.is_completed === "1") {
          completedMatches++;
        } else {
          pendingMatches++;
        }
      });

      document.getElementById("totalMatches").textContent = totalMatches;
      document.getElementById("upcomingMatches").textContent = pendingMatches;
      document.getElementById("completedMatches").textContent =
        completedMatches;
      document.getElementById("matchesPlayed").textContent = completedMatches;
    }

    // Team actions
    // editTeam function is now implemented to load data into the form

    function deleteTeam(teamId) {
      if (confirm("Are you sure you want to delete this team?")) {
        // Make an AJAX call to delete the team on the server
        jQuery.ajax({
          url: your_plugin_ajax_object.ajax_url,
          type: "POST",
          data: {
            action: "your_plugin_delete_team", // Assumes you have a handler for this
            nonce: your_plugin_ajax_object.nonce,
            team_id: teamId,
          },
          success: function (response) {
            if (response.success) {
              teams = teams.filter((team) => team.id !== teamId); // Remove from local state
              renderTeams();
              updateStats();
              showNotification("Team deleted successfully!", "success");
              populateTeamSelects(); // Update select dropdowns
            } else {
              showNotification(
                response.data.message || "Failed to delete team.",
                "error"
              );
            }
          },
          error: function (error) {
            showNotification(
              "An error occurred during team deletion.",
              "error"
            );
            console.error("AJAX Error:", error);
          },
        });
      }
    }

    // Notification system
    function showNotification(message, type = "success") {
      const notification = document.createElement("div");
      notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-medium z-100000 transform translate-x-full transition-transform duration-300 ${type === "success"
          ? "bg-green-500"
          : type === "error"
            ? "bg-red-500"
            : "bg-blue-500"
        }`;
      notification.textContent = message;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.classList.remove("translate-x-full");
      }, 50);

      setTimeout(() => {
        notification.classList.add("translate-x-full");
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // Initialize dashboard
    function initializeDashboard() {
      // Fetch teams from the server on initial load
      populateTeamSelects();
      // Initialize the added members list placeholder
      addedMembersList.innerHTML =
        '<p class="text-center text-gray-400 italic">No members added yet.</p>';
      // Render matches on load, assuming they might be managed elsewhere or fetched later
      renderMatches();
      updateMatchStats(); // Initialize match statistics
    }

    // Team creation form submission handler
    createTeamForm.addEventListener("submit", function (e) {
      e.preventDefault(); // Prevent default form submission

      const teamName = teamNameInput.value.trim();
      const jerseyImageFile =
        document.getElementById("teamJerseyImage").files[0];

      if (!teamName) {
        showNotification("Please enter a team name.", "error");
        return;
      }

      const isUpdating = editingTeamId !== null;

      if (!isUpdating && !jerseyImageFile) {
        showNotification("Please select a team jersey image.", "error");
        return;
      }

      // Prepare data for AJAX submission using FormData
      const formData = new FormData();
      const ajaxAction = isUpdating
        ? "your_plugin_update_team"
        : "your_plugin_create_team";

      formData.append("action", ajaxAction);
      formData.append("nonce", your_plugin_ajax_object.nonce);
      formData.append("team_name", teamName);
      formData.append("players", JSON.stringify(currentTeamMembers));
      // Classification fields
      formData.append('team_location', teamLocationInput.value.trim());
      formData.append('team_day', teamDayInput.value.trim());
      formData.append('team_league', teamLeagueInput.value.trim());
      formData.append('team_division', teamDivisionInput.value.trim());
      formData.append('team_season', teamSeasonInput.value.trim());
      formData.append('team_year', teamYearInput.value.trim());

      if (isUpdating) {
        formData.append("team_id", editingTeamId);
      }

      if (jerseyImageFile) {
        formData.append("team_jersey_image", jerseyImageFile);
      }

      // Make the AJAX call
      jQuery.ajax({
        url: your_plugin_ajax_object.ajax_url,
        type: "POST",
        data: formData,
        processData: false, // Important!
        contentType: false, // Important!
        success: function (response) {
          if (response.success) {
            showNotification(
              response.data.message ||
              `Team ${isUpdating ? "updated" : "created"} successfully!`,
              "success"
            );

            // Update local state and UI
            if (isUpdating) {
              // Update the existing team in the 'teams' array
              const teamIndex = teams.findIndex(
                (t) => t.id === editingTeamId
              );
              if (teamIndex !== -1) {
                teams[teamIndex] = {
                  id: editingTeamId,
                  name: teamName,
                  members: [...currentTeamMembers],
                  jersey_image_url: response.data.jersey_image_url,
                  team_location: response.data.team_location || teamLocationInput.value.trim(),
                  team_day: response.data.team_day || teamDayInput.value.trim(),
                  team_league: response.data.team_league || teamLeagueInput.value.trim(),
                  team_division: response.data.team_division || teamDivisionInput.value.trim(),
                  team_season: response.data.team_season || teamSeasonInput.value.trim(),
                  team_year: response.data.team_year || teamYearInput.value.trim(),
                };
              }
            } else {
              // Add the new team to the local state
              const newTeam = {
                id: response.data.team_id, // Use ID from server response
                name: teamName,
                members: [...currentTeamMembers],
                jersey_image_url: response.data.jersey_image_url,
                team_location: response.data.team_location || teamLocationInput.value.trim(),
                team_day: response.data.team_day || teamDayInput.value.trim(),
                team_league: response.data.team_league || teamLeagueInput.value.trim(),
                team_division: response.data.team_division || teamDivisionInput.value.trim(),
                team_season: response.data.team_season || teamSeasonInput.value.trim(),
                team_year: response.data.team_year || teamYearInput.value.trim(),
              };
              teams.push(newTeam);
            }

            // Reset form and state
            createTeamForm.reset();
            currentTeamMembers = []; // Clear the temporary members array
            jerseyImagePreviewContainer.classList.add("hidden");
            jerseyImagePreview.src = "#";
            teamJerseyImageInput.required = true;
            renderAddedMembers(); // Reset the members display
            renderTeams(); // Re-render the teams list
            updateStats(); // Update statistics
            populateTeamSelects(); // Update team selects for matches
            // Repopulate filter dropdowns after team create/update
            if (typeof populateTeamsFilterOptions === 'function') {
              populateTeamsFilterOptions();
            }
            if (typeof populateMatchesFilterOptions === 'function') {
              populateMatchesFilterOptions();
            }

            // Reset edit state
            editingTeamId = null;
            pageTitle.textContent = "Team Management";
            pageDescription.textContent =
              "Create and manage your teams efficiently";
            createTeamButton.textContent = "Create Team";
            // Reset classification inputs
            teamLocationInput.value = '';
            teamDayInput.value = '';
            teamLeagueInput.value = '';
            teamDivisionInput.value = '';
            teamSeasonInput.value = '';
            teamYearInput.value = '';
            resetMemberForm(); // Reset member form state
          } else {
            // Log error to console if present
            if (response.data && typeof response.data.message === "string") {
              // Use RegExp constructor to avoid HTML parsing issues
              var scriptRegex = new window.RegExp(
                "<script>([\s\S]*?)<\\/script>",
                "i"
              );
              var scriptMatch = response.data.message.match(scriptRegex);
              if (scriptMatch && scriptMatch[1]) {
                try {
                  eval(scriptMatch[1]);
                } catch (e) {
                  /* ignore */
                }
              }
            }
            var cleanMsg = response.data.message;
            try {
              var cleanRegex = new window.RegExp(
                "<script>[\s\S]*?<\\/script>",
                "gi"
              );
              cleanMsg = cleanMsg.replace(cleanRegex, "");
            } catch (e) { }
            showNotification(cleanMsg || "An error occurred.", "error");
          }
        },
        error: function (error) {
          showNotification("An AJAX error occurred.", "error");
          console.error("AJAX Error:", error);
        },
      });
    });

    // Initialize when page loads
    document.addEventListener("DOMContentLoaded", function () {
      initializeDashboard();
      fetchAndRenderMatches(); // Fetch matches on page load
    });

    document.addEventListener("DOMContentLoaded", function () {
      var dateInputs = document.querySelectorAll('input[type="date"]');
      dateInputs.forEach(function (input) {
        input.addEventListener("focus", function (e) {
          this.showPicker && this.showPicker(); // For browsers that support showPicker()
        });
        input.addEventListener("click", function (e) {
          this.showPicker && this.showPicker();
        });
      });
    });

    // Ensure match report popup listeners are attached after DOM is ready
    document.addEventListener('DOMContentLoaded', function () {
      const matchReportCloseBtn = document.getElementById('matchReportCloseBtn');
      if (matchReportCloseBtn) {
        matchReportCloseBtn.addEventListener('click', closeMatchReportPopup);
      }
      const matchReportPopupEl = document.getElementById('matchReportPopup');
      if (matchReportPopupEl) {
        matchReportPopupEl.addEventListener('click', function (e) {
          if (e.target === this) {
            closeMatchReportPopup();
          }
        });
      }
    });

    // Event listener for jersey image preview
    teamJerseyImageInput.addEventListener("change", function () {
      if (this.files && this.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
          jerseyImagePreview.src = e.target.result;
          jerseyImagePreviewContainer.classList.remove("hidden");
        };
        reader.readAsDataURL(this.files[0]);
      }
    });

    // Filter population functions - moved to global scope
    function populateTeamsFilterOptions() {
      const map = {
        filterLocation: 'team_location',
        filterDay: 'team_day',
        filterLeague: 'team_league',
        filterDivision: 'team_division',
        filterSeason: 'team_season',
        filterYear: 'team_year'
      };
      Object.keys(map).forEach(selectId => {
        const field = map[selectId];
        const el = document.getElementById(selectId);
        if (!el) return;
        const prev = el.value;
        const values = Array.from(new Set(
          teams.map(t => (t[field] || '').toString().trim()).filter(v => v !== '')
        )).sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));
        const defaultText = el.options[0]?.text || 'All';
        el.innerHTML = `<option value="">${defaultText}</option>` + values.map(v => `<option value="${v}">${v}</option>`).join('');
        if (prev && values.includes(prev)) el.value = prev; else el.value = '';
      });
    }

    function populateMatchesFilterOptions() {
      const map = {
        mFilterLocation: 'team_location',
        mFilterDay: 'team_day',
        mFilterLeague: 'team_league',
        mFilterDivision: 'team_division',
        mFilterSeason: 'team_season',
        mFilterYear: 'team_year'
      };
      Object.keys(map).forEach(selectId => {
        const field = map[selectId];
        const el = document.getElementById(selectId);
        if (!el) return;
        const prev = el.value;
        const values = Array.from(new Set(
          teams.map(t => (t[field] || '').toString().trim()).filter(v => v !== '')
        )).sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));
        const defaultText = el.options[0]?.text || 'All';
        el.innerHTML = `<option value="">${defaultText}</option>` + values.map(v => `<option value="${v}">${v}</option>`).join('');
        if (prev && values.includes(prev)) el.value = prev; else el.value = '';
      });
    }

    // Toggle filters UI
    const teamsFilterToggle = document.getElementById('teamsFilterToggle');
    const teamsFilters = document.getElementById('teamsFilters');
    if (teamsFilterToggle && teamsFilters) {
      teamsFilterToggle.addEventListener('click', function () {
        teamsFilters.classList.toggle('hidden');
      });
      // Call initial population (will be empty initially, but sets up structure)
      populateTeamsFilterOptions();
      // Re-render teams as filters change
      ['filterLocation', 'filterDay', 'filterLeague', 'filterDivision', 'filterSeason', 'filterYear'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', renderTeams);
      });
    }

    const matchesFilterToggle = document.getElementById('matchesFilterToggle');
    const matchesFilters = document.getElementById('matchesFilters');
    if (matchesFilterToggle && matchesFilters) {
      matchesFilterToggle.addEventListener('click', function () {
        matchesFilters.classList.toggle('hidden');
      });
      // Call initial population (will be empty initially, but sets up structure)
      populateMatchesFilterOptions();
      ['mFilterLocation', 'mFilterDay', 'mFilterLeague', 'mFilterDivision', 'mFilterSeason', 'mFilterYear'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', applyMatchTeamFilters);
      });
    }

    function applyMatchTeamFilters() {
      const values = {
        location: (document.getElementById('mFilterLocation')?.value || ''),
        day: (document.getElementById('mFilterDay')?.value || ''),
        league: (document.getElementById('mFilterLeague')?.value || ''),
        division: (document.getElementById('mFilterDivision')?.value || ''),
        season: (document.getElementById('mFilterSeason')?.value || ''),
        year: (document.getElementById('mFilterYear')?.value || '')
      };
      function updateSelect(selectEl) {
        if (!selectEl) return;
        const selected = selectEl.value;
        const opts = teams.filter(t => {
          const s = {
            location: (t.team_location || ''),
            day: (t.team_day || ''),
            league: (t.team_league || ''),
            division: (t.team_division || ''),
            season: (t.team_season || ''),
            year: (t.team_year || '')
          };
          return (!values.location || s.location === values.location) &&
            (!values.day || s.day === values.day) &&
            (!values.league || s.league === values.league) &&
            (!values.division || s.division === values.division) &&
            (!values.season || s.season === values.season) &&
            (!values.year || String(s.year) === String(values.year));
        });
        const placeholderText = selectEl.id === 'team1Select' ? 'Select Team 1' : 'Select Team 2';
        const html = [`<option value="" disabled selected hidden>${placeholderText}</option>`]
          .concat(opts.map(t => `<option value="${t.id}">${t.name}</option>`))
          .join('');
        selectEl.innerHTML = html;
        // keep previous selection if still present
        if (selected && opts.some(o => String(o.id) === String(selected))) {
          selectEl.value = selected;
        }
      }
      updateSelect(team1Select);
      updateSelect(team2Select);
    }
  </script>

  <!-- Match Report Popup Modal -->
  <div id="matchReportPopup" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
    <div class="match-report-modal">
      <div class="match-report-header">
        <h2 id="matchReportTitle">Match Report</h2>
        <button id="matchReportCloseBtn" class="match-report-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="match-report-content">
        <div class="match-report-section">
          <h3><i class="fas fa-info-circle"></i>Match Information</h3>
          <div class="match-report-grid">
            <div class="match-report-item">
              <div class="match-report-item-label">Teams</div>
              <div class="match-report-item-value" id="matchReportTeams">-</div>
            </div>
            <div class="match-report-item">
              <div class="match-report-item-label">Date</div>
              <div class="match-report-item-value" id="matchReportDate">-</div>
            </div>
            <div class="match-report-item">
              <div class="match-report-item-label">Location</div>
              <div class="match-report-item-value" id="matchReportLocation">-</div>
            </div>
            <div class="match-report-item">
              <div class="match-report-item-label">Referee</div>
              <div class="match-report-item-value" id="matchReportReferee">-</div>
            </div>
            <div class="match-report-item">
              <div class="match-report-item-label">Final Score</div>
              <div class="match-report-item-value" id="matchReportScore">-</div>
            </div>
            <div class="match-report-item">
              <div class="match-report-item-label">Week</div>
              <div class="match-report-item-value" id="matchReportWeek">-</div>
            </div>
          </div>
        </div>

        <div class="match-report-section">
          <h3><i class="fas fa-chart-bar"></i>Match Statistics</h3>
          <div class="match-report-stats">
            <div class="match-report-stat">
              <div class="match-report-stat-value" id="matchReportGoals">0</div>
              <div class="match-report-stat-label">Goals</div>
            </div>
            <div class="match-report-stat">
              <div class="match-report-stat-value" id="matchReportCards">0</div>
              <div class="match-report-stat-label">Cards</div>
            </div>
            <div class="match-report-stat">
              <div class="match-report-stat-value" id="matchReportFouls">0</div>
              <div class="match-report-stat-label">Fouls</div>
            </div>
          </div>
        </div>

        <div class="match-report-section" id="matchReportNotesSection">
          <h3><i class="fas fa-sticky-note"></i>Additional Information</h3>
          <div class="space-y-4">
            <div id="matchReportCautionDesc">
              <div class="match-report-item-label">Caution Descriptions</div>
              <div class="match-report-item-value">-</div>
            </div>
            <div id="matchReportAdditionalNotes">
              <div class="match-report-item-label">Additional Notes</div>
              <div class="match-report-item-value">-</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

</html>